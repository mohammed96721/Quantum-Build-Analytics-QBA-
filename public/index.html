<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حساب تكاليف البناء - العراق</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        :root {
            --primary: #5C4033; --accent: #E8B923; --background: #F5F1E9; --secondary-bg: #EDE7E0;
            --highlight: #A8C4A2; --text: #2A2A2A; --danger: #C75656; --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --border: #E4E2DB; --transparent-bg: rgba(255, 245, 235, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background: linear-gradient(135deg, #FFF6E6, #F5F1E9); color: var(--text); line-height: 1.5; overflow-x: hidden; }
        .container { max-width: 700px; margin: 15px auto; padding: 8px; }
        .language-selector select {
            padding: 4px 6px; font-size: 0.75rem; border-radius: 5px; border: 1px solid var(--border);
            background: var(--transparent-bg); cursor: pointer; transition: all 0.2s; max-width: 120px;
        }
        .language-selector select:focus { border-color: var(--accent); box-shadow: 0 0 3px rgba(232, 185, 35, 0.5); }
        .disclaimer {
            background: var(--transparent-bg); border-right: 3px solid var(--accent); padding: 8px; margin-bottom: 10px;
            border-radius: 5px; box-shadow: var(--shadow); backdrop-filter: blur(6px); animation: fadeIn 0.3s;
        }
        .disclaimer h2 { color: var(--danger); font-size: 0.85rem; margin-bottom: 3px; display: flex; align-items: center; gap: 4px; }
        .disclaimer p { font-size: 0.65rem; }
        .form-card { background: var(--secondary-bg); border-radius: 6px; box-shadow: var(--shadow); padding: 10px; margin-bottom: 12px; }
        .form-header { text-align: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
        .form-header h2 { color: var(--primary); font-size: 1.1rem; display: flex; justify-content: center; align-items: center; gap: 4px; }
        .form-header p { font-size: 0.6rem; }
        .form-section {
            margin-bottom: 8px; padding: 8px; background: var(--transparent-bg); border-radius: 5px;
            border-left: 3px solid var(--primary); transition: transform 0.2s, box-shadow 0.2s;
        }
        .form-section:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); }
        .form-section h3 { color: var(--primary); font-size: 0.95rem; margin-bottom: 5px; display: flex; align-items: center; gap: 4px; }
        .form-group { margin-bottom: 6px; position: relative; }
        .form-group label { display: block; margin-bottom: 2px; font-weight: 500; font-size: 0.7rem; }
        .form-control {
            width: 100%; max-width: 200px; padding: 4px 6px; border: 1px solid var(--border); border-radius: 5px;
            font-size: 0.75rem; background: var(--transparent-bg); transition: all 0.2s; height: 26px;
            text-align: left;
        }
        .form-control:focus { border-color: var(--accent); box-shadow: 0 0 6px rgba(232, 185, 35, 0.3); transform: scale(1.01); outline: none; }
        .form-control:invalid:focus { border-color: var(--danger); box-shadow: 0 0 6px rgba(199, 86, 86, 0.3); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 6px; }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 4px; font-weight: 500;
            padding: 6px 12px; font-size: 0.75rem; border-radius: 5px; border: none; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #D4A017); color: var(--text); }
        .btn-primary:hover { background: linear-gradient(135deg, #D4A017, var(--accent)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(232, 185, 35, 0.4); }
        .btn-reset { background: linear-gradient(135deg, var(--danger), #A13636); color: #FFFFFF; }
        .btn-reset:hover { background: linear-gradient(135deg, #A13636, var(--danger)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(199, 86, 86, 0.4); }
        .btn-block { width: 100%; max-width: 200px; }
        .hidden { display: none; }
        .toggle-section {
            background: var(--transparent-bg); padding: 6px; border-radius: 5px; margin-bottom: 5px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); transition: all 0.2s;
        }
        .toggle-section:hover { background: rgba(255, 245, 235, 0.98); transform: translateY(-1px); }
        .map-toggle { background: linear-gradient(135deg, var(--highlight), #8BAF7F); padding: 10px; font-size: 0.95rem; font-weight: 600; border-radius: 6px; box-shadow: 0 3px 10px rgba(168, 196, 162, 0.3); color: #FFFFFF; }
        .map-toggle:hover { background: linear-gradient(135deg, #8BAF7F, var(--highlight)); transform: translateY(-2px); }
        .toggle-content { padding: 6px; background: var(--transparent-bg); border-radius: 5px; margin-top: 4px; border: 1px solid var(--border); animation: fadeIn 0.3s; }
        .checkbox-group { display: flex; align-items: center; gap: 4px; margin-bottom: 5px; }
        .checkbox-group input { width: 12px; height: 12px; accent-color: var(--primary); }
        .result-container { margin-top: 10px; padding: 10px; background: linear-gradient(135deg, var(--primary), #7A5A45); border-radius: 6px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); color: #FFFFFF; display: none; animation: slideIn 0.3s; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-header h3 { font-size: 1rem; display: flex; align-items: center; gap: 4px; }
        .result-content table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .result-content th, .result-content td { padding: 6px; text-align: right; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-content th { background: rgba(255, 255, 255, 0.1); color: #FFFFFF; }
        .error-message { color: var(--danger); font-size: 0.6rem; margin-top: 2px; display: none; animation: fadeIn 0.2s; }
        .tooltip { position: absolute; background: var(--primary); color: #FFFFFF; padding: 2px 5px; border-radius: 4px; font-size: 0.6rem; top: -22px; right: 5px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .form-group:hover .tooltip { opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(6px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .form-control, .btn-block { max-width: 100%; }
            .container { padding: 5px; }
            .form-card { padding: 8px; }
            .form-section { padding: 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-selector">
            <select id="languageSelect" class="form-control"><option value="ar">العربية</option></select>
        </div>
        <div class="disclaimer">
            <h2><span class="material-icons-outlined">warning</span> تنبيه قانوني</h2>
            <p>هذه الأداة مخصصة للأفراد في العراق فقط. يحظر استخدامها من قبل الشركات بدون تصريح. سيتم اتخاذ إجراءات قانونية ضد الاستخدام غير المرخص. الأداة مشفرة لحماية خوارزمياتها.</p>
        </div>
        <div class="form-card">
            <div class="form-header">
                <h2><span class="material-icons-outlined">calculate</span> حاسبة تكاليف البناء</h2>
                <p>أدخل تفاصيل المشروع لتقدير التكلفة</p>
            </div>
            <form id="buildingForm">
                <div class="form-section">
                    <h3><span class="material-icons-outlined">person</span> معلومات الزبون</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">الاسم الكامل</label>
                            <input type="text" id="customerName" class="form-control" required>
                            <div class="error-message" id="customerNameError">الرجاء إدخال الاسم</div>
                            <span class="tooltip">أدخل الاسم الكامل</span>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">رقم الهاتف</label>
                            <input type="tel" id="phoneNumber" class="form-control" required>
                            <div class="error-message" id="phoneNumberError">الرجاء إدخال رقم هاتف</div>
                            <span class="tooltip">أدخل رقم هاتف صالح</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">location_on</span> موقع الأرض</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="governorate">المحافظة</label>
                            <select id="governorate" class="form-control" required>
                                <option value="">اختر المحافظة</option>
                                <option value="baghdad">بغداد</option><option value="basra">البصرة</option>
                                <option value="najaf">النجف</option><option value="karbala">كربلاء</option>
                                <option value="erbil">أربيل</option><option value="sulaymaniyah">السليمانية</option>
                                <option value="duhok">دهوك</option><option value="kirkuk">كركوك</option>
                                <option value="mosul">الموصل</option><option value="anbar">الأنبار</option>
                                <option value="saladin">صلاح الدين</option><option value="diyala">ديالى</option>
                                <option value="wasit">واسط</option><option value="babil">بابل</option>
                                <option value="qadisiyah">القادسية</option><option value="muthanna">المثنى</option>
                                <option value="dhi_qar">ذي قار</option><option value="maysan">ميسان</option>
                            </select>
                            <div class="error-message" id="governorateError">الرجاء اختيار المحافظة</div>
                            <span class="tooltip">اختر المحافظة</span>
                        </div>
                        <div class="form-group">
                            <label for="area">المنطقة/الحي</label>
                            <input type="text" id="area" class="form-control" required>
                            <div class="error-message" id="areaError">الرجاء إدخال المنطقة</div>
                            <span class="tooltip">حدد الحي أو المنطقة</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">square_foot</span> مواصفات الأرض</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="landArea">مساحة الأرض (م²)</label>
                            <input type="number" id="landArea" class="form-control" required step="0.01">
                            <div class="error-message" id="landAreaError">الرجاء إدخال مساحة</div>
                            <span class="tooltip">أدخل مساحة الأرض</span>
                        </div>
                        <div class="form-group">
                            <label for="facadeWidth">عرض الواجهة (م)</label>
                            <input type="number" id="facadeWidth" class="form-control" required step="0.01">
                            <div class="error-message" id="facadeWidthError">الرجاء إدخال عرض</div>
                            <span class="tooltip">أدخل عرض الواجهة</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">apartment</span> مواصفات البناء</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="floors">عدد الطوابق</label>
                            <input type="number" id="floors" class="form-control" required>
                            <div class="error-message" id="floorsError">الرجاء إدخال عدد</div>
                            <span class="tooltip">حدد عدد الطوابق</span>
                        </div>
                        <div class="form-group">
                            <label for="rooms">عدد الغرف</label>
                            <input type="number" id="rooms" class="form-control" required>
                            <div class="error-message" id="roomsError">الرجاء إدخال عدد</div>
                            <span class="tooltip">حدد عدد الغرف</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="groundFloorHeight">ارتفاع الطابق الأرضي (م)</label>
                            <input type="number" id="groundFloorHeight" class="form-control" required step="0.01">
                            <div class="error-message" id="groundFloorHeightError">الرجاء إدخال ارتفاع</div>
                            <span class="tooltip">أدخل ارتفاع الطابق الأرضي</span>
                        </div>
                        <div class="form-group">
                            <label for="otherFloorsHeight">ارتفاع باقي الطوابق (م)</label>
                            <input type="number" id="otherFloorsHeight" class="form-control" required step="0.01">
                            <div class="error-message" id="otherFloorsHeightError">الرجاء إدخال ارتفاع</div>
                            <span class="tooltip">أدخل ارتفاع باقي الطوابق</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ceilingThickness">سمك السقف (م)</label>
                            <input type="number" id="ceilingThickness" class="form-control" required step="0.01">
                            <div class="error-message" id="ceilingThicknessError">الرجاء إدخال سمك السقف</div>
                            <span class="tooltip">أدخل سمك السقف</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bathrooms">عدد الحمامات</label>
                            <input type="number" id="bathrooms" class="form-control" required>
                            <div class="error-message" id="bathroomsError">الرجاء إدخال عدد</div>
                            <span class="tooltip">حدد عدد الحمامات</span>
                        </div>
                        <div class="form-group">
                            <label for="brickType">نوع الطابوق</label>
                            <select id="brickType" class="form-control" required>
                                <option value="yellow">أصفر</option>
                                <option value="red">أحمر</option>
                                <option value="thermostone">ثرمستون</option>
                            </select>
                            <span class="tooltip">اختر نوع الطابوق</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">attach_money</span> أسعار التشطيبات</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="flooringPrice">سعر م² تشطيب الأرضيات</label>
                            <input type="number" id="flooringPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="flooringPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر الأرضيات</span>
                        </div>
                        <div class="form-group">
                            <label for="wallInstallationPrice">سعر م² تركيب الجدران</label>
                            <input type="number" id="wallInstallationPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="wallInstallationPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر الجدران</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="wallPaintingPrice">سعر م² صبغ الجدران</label>
                            <input type="number" id="wallPaintingPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="wallPaintingPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر صبغ الجدران</span>
                        </div>
                        <div class="form-group">
                            <label for="windowsDoorsPrice">سعر م² شبابيك وأبواب</label>
                            <input type="number" id="windowsDoorsPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="windowsDoorsPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر الشبابيك</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">build</span> خيارات إضافية</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ceilingDetails">تفاصيل السقف</label>
                            <select id="ceilingDetails" class="form-control" required>
                                <option value="plywood">بلي وود</option>
                                <option value="regular">عادي</option>
                                <option value="waffle">Waffle Slab</option>
                            </select>
                            <span class="tooltip">اختر تفاصيل السقف</span>
                        </div>
                        <div class="form-group">
                            <label for="facadeType">نوع الواجهة</label>
                            <select id="facadeType" class="form-control" required>
                                <option value="economy">اقتصادية</option>
                                <option value="simple">تفاصيل بسيطة</option>
                                <option value="luxury">فخمة</option>
                                <option value="custom">مخصصة</option>
                            </select>
                            <span class="tooltip">اختر نوع الواجهة</span>
                        </div>
                    </div>
                    <div id="waffleSlabInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="voidSize">حجم الفراغ (م³)</label>
                                <input type="number" id="voidSize" class="form-control" step="0.01">
                                <span class="tooltip">أدخل حجم الفراغ</span>
                            </div>
                            <div class="form-group">
                                <label for="voidCount">عددها</label>
                                <input type="number" id="voidCount" class="form-control">
                                <span class="tooltip">أدخل عدد الفراغات</span>
                            </div>
                        </div>
                    </div>
                    <div id="customFacadeInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="facadeArea">مساحة الواجهة المخصصة (م²)</label>
                                <input type="number" id="facadeArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الواجهة</span>
                            </div>
                            <div class="form-group">
                                <label for="facadePrice">سعر م² الواجهة</label>
                                <input type="number" id="facadePrice" class="form-control" step="0.01">
                                <span class="tooltip">أدخل سعر الواجهة</span>
                            </div>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleApartments">
                        <span><span class="material-icons-outlined">apartment</span> شقق سكنية</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="apartmentsInfo" class="toggle-content hidden">
                        <div class="form-group">
                            <label for="apartmentsCount">عدد الشقق</label>
                            <input type="number" id="apartmentsCount" class="form-control">
                            <span class="tooltip">حدد عدد الشقق</span>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleBasement">
                        <span><span class="material-icons-outlined">garage</span> طوابق سفلية</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="basementInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="basementFloors">عدد الطوابق السفلية</label>
                                <input type="number" id="basementFloors" class="form-control">
                                <span class="tooltip">حدد عدد الطوابق السفلية</span>
                            </div>
                            <div class="form-group">
                                <label for="basementCeilingArea">مساحة السقوف (م²)</label>
                                <input type="number" id="basementCeilingArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                            <div class="form-group">
                                <label for="basementPrice">سعر م² الطوابق السفلية</label>
                                <input type="number" id="basementPrice" class="form-control" step="0.01">
                                <span class="tooltip">أدخل سعر الطوابق السفلية</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">home</span> المرافق</h3>
                    <div class="form-row">
                        <div class="checkbox-group"><input type="checkbox" id="hasGarden"><label for="hasGarden"><span class="material-icons-outlined">yard</span> حديقة داخلية</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasPool"><label for="hasPool"><span class="material-icons-outlined">pool</span> مسبح</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasHVAC"><label for="hasHVAC"><span class="material-icons-outlined">ac_unit</span> تدفئة وتبريد</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasElevator"><label for="hasElevator"><span class="material-icons-outlined">elevator</span> مصعد</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasFence"><label for="hasFence"><span class="material-icons-outlined">fence</span> سياج خارجي</label></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="toggle-section map-toggle" id="toggleMapDetails">
                        <span><span class="material-icons-outlined">map</span> تفاصيل الخريطة</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="mapDetailsInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="totalRoofArea">مساحة السقوف (م²)</label>
                                <input type="number" id="totalRoofArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                            <div class="form-group">
                                <label for="gardenArea">مساحة الحديقة (م²)</label>
                                <input type="number" id="gardenArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الحديقة</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="garagePathArea">مساحة الكراج والممرات (م²)</label>
                                <input type="number" id="garagePathArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الكراج</span>
                            </div>
                            <div class="form-group">
                                <label for="skylightsArea">مساحة المناور (م²)</label>
                                <input type="number" id="skylightsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة المناور</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tiesLength">طول الرباطات (م)</label>
                                <input type="number" id="tiesLength" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الرباطات</span>
                            </div>
                            <div class="form-group">
                                <label for="invertedBeams">طول الجسور المقلوبة (م)</label>
                                <input type="number" id="invertedBeams" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الجسور</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="externalWalls24cm">أطوال الجدران الخارجية المحيطية فقط بدون السياج (م)</label>
                                <input type="number" id="externalWalls24cm" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الجدران</span>
                            </div>
                            <div class="form-group">
                                <label for="internalWalls24cm">أطوال الجدران الداخلية (م)</label>
                                <input type="number" id="internalWalls24cm" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="roofFenceLength">طول ستارة السطح (م)</label>
                                <input type="number" id="roofFenceLength" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول السياج</span>
                            </div>
                            <div class="form-group">
                                <label for="externalDoors">عدد الأبواب الخارجية</label>
                                <input type="number" id="externalDoors" class="form-control">
                                <span class="tooltip">حدد عدد الأبواب</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="internalDoors">عدد الأبواب الداخلية</label>
                                <input type="number" id="internalDoors" class="form-control">
                                <span class="tooltip">حدد عدد الأبواب</span>
                            </div>
                            <div class="form-group">
                                <label for="facadeWindowsDoorsArea">مساحة شبابيك وأبواب الواجهة (م²)</label>
                                <input type="number" id="facadeWindowsDoorsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الشبابيك</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="skylightWindowsDoorsArea">مساحة شبابيك المناور (م²)</label>
                                <input type="number" id="skylightWindowsDoorsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة المناور</span>
                            </div>
                            <div class="form-group">
                                <label for="secondaryCeilingsArea">مساحة السقوف الثانوية (م²)</label>
                                <input type="number" id="secondaryCeilingsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="decorativeWallsArea">مساحة الجدران الديكورية (م²)</label>
                                <input type="number" id="decorativeWallsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                            <div class="form-group">
                                <label for="plasterWallsArea">مساحة لبخ الجدران (م²)</label>
                                <input type="number" id="plasterWallsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة لبخ الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="claddingWallsArea">مساحة الجدران التغليف (م²)</label>
                                <input type="number" id="claddingWallsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                        </div>
                        <div class="toggle-section" id="toggleStairsRailing">
                            <span><span class="material-icons-outlined">stairs</span> محجر الدرج</span>
                            <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                        </div>
                        <div id="stairsRailingInfo" class="toggle-content hidden">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="stairsRailingLength">طول محجر الدرج (م)</label>
                                    <input type="number" id="stairsRailingLength" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل طول محجر الدرج</span>
                                </div>
                                <div class="form-group">
                                    <label for="stairsRailingPrice">سعر المتر الطولي</label>
                                    <input type="number" id="stairsRailingPrice" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل سعر محجر الدرج</span>
                                </div>
                            </div>
                        </div>
                        <div class="toggle-section" id="toggleConcreteColumns">
                            <span><span class="material-icons-outlined">foundation</span> أعمدة كونكريت أو كتل كونكريتية تحسب حجومها كاملة مع بعض</span>
                            <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                        </div>
                        <div id="concreteColumnsInfo" class="toggle-content hidden">
                            <div class="form-group">
                                <label for="concreteVolume">حجم الكونكريت (م³)</label>
                                <input type="number" id="concreteVolume" class="form-control" step="0.01">
                                <span class="tooltip">أدخل حجم الكونكريت</span>
                            </div>
                        </div>
                        <div class="toggle-section" id="toggleInternalWalls">
                            <span><span class="material-icons-outlined">wallpaper</span> جدران داخلية</span>
                            <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                        </div>
                        <div id="internalWallsInfo" class="toggle-content hidden">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="internalWallsArea">مساحة الجدران (م²)</label>
                                    <input type="number" id="internalWallsArea" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل مساحة الجدران</span>
                                </div>
                                <div class="form-group">
                                    <label for="internalWallsPrice">سعر م² الجدران</label>
                                    <input type="number" id="internalWallsPrice" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل سعر الجدران</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block"><span class="material-icons-outlined">calculate</span> حساب التكلفة</button>
                    </div>
                    <div class="form-group">
                        <button type="reset" class="btn btn-reset btn-block"><span class="material-icons-outlined">delete</span> إعادة تعيين</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="resultContainer" class="result-container hidden">
            <div class="result-header">
                <h3><span class="material-icons-outlined">assessment</span> نتيجة الحساب</h3>
            </div>
            <div id="resultContent" class="result-content"></div>
        </div>
    </div>
    <script>
        // تعريف أزرار التبديل ومحتواها
        const toggles = [
            { toggle: 'toggleApartments', content: 'apartmentsInfo' },
            { toggle: 'toggleBasement', content: 'basementInfo' },
            { toggle: 'toggleMapDetails', content: 'mapDetailsInfo' },
            { toggle: 'toggleStairsRailing', content: 'stairsRailingInfo' },
            { toggle: 'toggleConcreteColumns', content: 'concreteColumnsInfo' },
            { toggle: 'toggleInternalWalls', content: 'internalWallsInfo' }
        ];

        // إضافة أحداث التبديل لإظهار/إخفاء الأقسام
        toggles.forEach(({ toggle, content }) => {
            const toggleBtn = document.getElementById(toggle);
            const contentDiv = document.getElementById(content);
            if (toggleBtn && contentDiv) {
                toggleBtn.addEventListener('click', () => {
                    contentDiv.classList.toggle('hidden');
                    toggleBtn.querySelector('.toggle-icon span').textContent = contentDiv.classList.contains('hidden') ? 'add' : 'remove';
                });
            } else {
                console.warn(`تحذير: العنصر ${toggle} أو ${content} غير موجود`);
            }
        });

        // إظهار/إخفاء الأقسام بناءً على اختيارات القوائم
        const toggleSelect = (selectId, contentId, triggerValue) => {
            const select = document.getElementById(selectId);
            const content = document.getElementById(contentId);
            if (select && content) {
                select.addEventListener('change', () => {
                    content.classList.toggle('hidden', select.value !== triggerValue);
                });
            } else {
                console.warn(`تحذير: العنصر ${selectId} أو ${contentId} غير موجود`);
            }
        };
        toggleSelect('facadeType', 'customFacadeInfo', 'custom');
        toggleSelect('ceilingDetails', 'waffleSlabInfo', 'waffle');

        // التحقق من صحة الحقول المطلوبة
        document.querySelectorAll('.form-control[required]').forEach(input => {
            input.addEventListener('input', () => {
                const errorDiv = document.getElementById(`${input.id}Error`);
                if (errorDiv) {
                    errorDiv.style.display = input.validity.valid ? 'none' : 'block';
                }
                input.style.borderColor = input.validity.valid ? '' : 'var(--danger)';
            });
        });

        // معالجة إرسال النموذج
        document.getElementById('buildingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('بدء معالجة إرسال النموذج');

            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (!submitBtn) {
                console.error('خطأ: زر الإرسال غير موجود');
                return;
            }
            submitBtn.innerHTML = '<span class="material-icons-outlined">hourglass_top</span> جارٍ الحساب...';
            submitBtn.disabled = true;

            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');
            if (!resultContainer || !resultContent) {
                console.error('خطأ: عنصر resultContainer أو resultContent غير موجود في DOM');
                submitBtn.innerHTML = '<span class="material-icons-outlined">calculate</span> حساب التكلفة';
                submitBtn.disabled = false;
                return;
            }

            // دالة لجمع القيم من الحقول
            const getValue = (id, isFloat = false, isInt = false) => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`تحذير: العنصر ${id} غير موجود`);
                    return isInt ? 0 : isFloat ? 0 : '';
                }
                let value = element.value.replace(/,/g, '');
                return isFloat ? parseFloat(value) || 0 : isInt ? parseInt(value) || 0 : value;
            };

            try {
                console.log('جمع البيانات من النموذج');
                // جمع البيانات من النموذج
                const inputs = {
                    customer: {
                        name: getValue('customerName'),
                        phone: getValue('phoneNumber')
                    },
                    location: {
                        governorate: getValue('governorate'),
                        area: getValue('area')
                    },
                    land: {
                        area: getValue('landArea', true),
                        facadeWidth: getValue('facadeWidth', true)
                    },
                    building: {
                        floors: getValue('floors', false, true),
                        rooms: getValue('rooms', false, true),
                        bathrooms: getValue('bathrooms', false, true),
                        groundFloorHeight: getValue('groundFloorHeight', true),
                        otherFloorsHeight: getValue('otherFloorsHeight', true),
                        ceilingThickness: getValue('ceilingThickness', true),
                        brickType: getValue('brickType'),
                        ceilingDetails: getValue('ceilingDetails'),
                        facadeType: getValue('facadeType'),
                        hasGarden: document.getElementById('hasGarden')?.checked || false,
                        hasPool: document.getElementById('hasPool')?.checked || false,
                        hasHVAC: document.getElementById('hasHVAC')?.checked || false,
                        hasElevator: document.getElementById('hasElevator')?.checked || false,
                        hasFence: document.getElementById('hasFence')?.checked || false
                    },
                    prices: {
                        flooring: getValue('flooringPrice', true),
                        wallInstallation: getValue('wallInstallationPrice', true),
                        wallPainting: getValue('wallPaintingPrice', true),
                        windowsDoors: getValue('windowsDoorsPrice', true)
                    },
                    hasMap: !document.getElementById('mapDetailsInfo')?.classList.contains('hidden') || false,
                    customFacadeInfo: !document.getElementById('customFacadeInfo')?.classList.contains('hidden') || false,
                    waffleSlabInfo: !document.getElementById('waffleSlabInfo')?.classList.contains('hidden') || false,
                    apartmentsInfo: !document.getElementById('apartmentsInfo')?.classList.contains('hidden') || false,
                    basementInfo: !document.getElementById('basementInfo')?.classList.contains('hidden') || false,
                    stairsRailingInfo: document.getElementById('mapDetailsInfo')?.classList.contains('hidden') ? false : !document.getElementById('stairsRailingInfo')?.classList.contains('hidden') || false,
                    concreteColumnsInfo: document.getElementById('mapDetailsInfo')?.classList.contains('hidden') ? false : !document.getElementById('concreteColumnsInfo')?.classList.contains('hidden') || false,
                    internalWallsInfo: document.getElementById('mapDetailsInfo')?.classList.contains('hidden') ? false : !document.getElementById('internalWallsInfo')?.classList.contains('hidden') || false
                };

                // جمع بيانات الواجهة المخصصة
                if (inputs.customFacadeInfo) {
                    inputs.building.facadeArea = getValue('facadeArea', true);
                    inputs.building.facadePrice = getValue('facadePrice', true);
                }

                // جمع بيانات تفاصيل السقف (Waffle Slab)
                if (inputs.waffleSlabInfo) {
                    inputs.building.voidSize = getValue('voidSize', true);
                    inputs.building.voidCount = getValue('voidCount', false, true);
                }

                // جمع بيانات الشقق
                if (inputs.apartmentsInfo) {
                    inputs.building.apartmentsCount = getValue('apartmentsCount', false, true);
                }

                // جمع بيانات الطوابق السفلية
                if (inputs.basementInfo) {
                    inputs.building.basementFloors = getValue('basementFloors', false, true);
                    inputs.building.basementCeilingArea = getValue('basementCeilingArea', true);
                    inputs.building.basementPrice = getValue('basementPrice', true);
                }

                // جمع بيانات محجر الدرج
                if (inputs.stairsRailingInfo && inputs.hasMap) {
                    inputs.stairsRailingLength = getValue('stairsRailingLength', true);
                    inputs.prices.stairsRailing = getValue('stairsRailingPrice', true);
                }

                // جمع بيانات تفاصيل الخريطة
                if (inputs.hasMap) {
                    inputs.technicalDetails = inputs.technicalDetails || {};
                    inputs.technicalDetails.totalRoofArea = getValue('totalRoofArea', true);
                    inputs.technicalDetails.gardenArea = getValue('gardenArea', true);
                    inputs.technicalDetails.garagePathArea = getValue('garagePathArea', true);
                    inputs.technicalDetails.skylightsArea = getValue('skylightsArea', true);
                    inputs.technicalDetails.tiesLength = getValue('tiesLength', true);
                    inputs.technicalDetails.invertedBeams = getValue('invertedBeams', true);
                    inputs.technicalDetails.externalWalls24cm = getValue('externalWalls24cm', true);
                    inputs.technicalDetails.internalWalls24cm = getValue('internalWalls24cm', true);
                    inputs.technicalDetails.roofFenceLength = getValue('roofFenceLength', true);
                    inputs.technicalDetails.externalDoors = getValue('externalDoors', false, true);
                    inputs.technicalDetails.internalDoors = getValue('internalDoors', false, true);
                    inputs.technicalDetails.facadeWindowsDoorsArea = getValue('facadeWindowsDoorsArea', true);
                    inputs.technicalDetails.skylightWindowsDoorsArea = getValue('skylightWindowsDoorsArea', true);
                    inputs.technicalDetails.secondaryCeilingsArea = getValue('secondaryCeilingsArea', true);
                    inputs.technicalDetails.decorativeWallsArea = getValue('decorativeWallsArea', true);
                    inputs.technicalDetails.claddingWallsArea = getValue('claddingWallsArea', true);
                    inputs.technicalDetails.plasterWallsArea = getValue('plasterWallsArea', true);
                }

                // جمع بيانات الجدران الداخلية
                if (inputs.internalWallsInfo && inputs.hasMap) {
                    inputs.technicalDetails = inputs.technicalDetails || {};
                    inputs.technicalDetails.internalWallsArea = getValue('internalWallsArea', true);
                    inputs.prices.internalWalls = getValue('internalWallsPrice', true);
                }

                // جمع بيانات أعمدة الكونكريت
                if (inputs.concreteColumnsInfo && inputs.hasMap) {
                    inputs.technicalDetails = inputs.technicalDetails || {};
                    inputs.technicalDetails.concreteVolume = getValue('concreteVolume', true);
                }

                console.log('البيانات المُرسلة:', JSON.stringify(inputs, null, 2));

                // إرسال الطلب إلى /api/process
                console.log('إرسال الطلب إلى /api/process');
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },
                    body: JSON.stringify(inputs)
                });

                console.log('حالة الاستجابة:', response.status, response.statusText);
                console.log('رأس Content-Type:', response.headers.get('Content-Type'));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('نص خطأ الاستجابة:', errorText);
                    throw new Error(`خطأ في الاتصال: ${response.status} ${response.statusText} - ${errorText}`);
                }

                let result;
                try {
                    // التحقق من نوع الاستجابة
                    const contentType = response.headers.get('Content-Type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                        console.log('الاستجابة من /api/process:', JSON.stringify(result, null, 2));
                    } else {
                        const text = await response.text();
                        console.error('الاستجابة ليست JSON:', text);
                        throw new Error('الخادم أرجع استجابة غير JSON');
                    }
                } catch (jsonError) {
                    console.error('خطأ في تحليل JSON:', jsonError);
                    throw new Error(`فشل في تحليل استجابة الخادم: ${jsonError.message}`);
                }

                // التحقق من نجاح الاستجابة (بمرونة أكبر)
                if (!result || typeof result !== 'object') {
                    throw new Error('استجابة غير صالحة: البيانات فارغة أو غير كائن');
                }

                // تحقق مرن: إما أن تحتوي على pdfData مباشرة أو داخل result
                const pdfData = result.pdfData || (result.result && result.result.pdfData);
                if (!pdfData) {
                    console.error('هيكلية الاستجابة:', JSON.stringify(result, null, 2));
                    throw new Error(result.message || result.result?.message || 'فشل معالجة البيانات: pdfData غير موجود');
                }

                // عرض رسالة النجاح
                resultContent.innerHTML = `
                    <div class="result-section">
                        <h3><span class="material-icons-outlined">check_circle</span> تم الحساب بنجاح</h3>
                        <p>اضغط على الزر أدناه لتحميل ملف PDF</p>
                        <button id="downloadPdfBtn" class="btn btn-primary"><span class="material-icons-outlined">picture_as_pdf</span> تحميل PDF</button>
                    </div>
                `;
                resultContainer.classList.remove('hidden');
                resultContainer.style.display = 'block';
                console.log('تم عرض رسالة النجاح وزِر تحميل PDF');

                // إنشاء ملف PDF عند الضغط على زر التحميل
                const downloadBtn = document.getElementById('downloadPdfBtn');
                if (!downloadBtn) {
                    console.error('خطأ: زر downloadPdfBtn غير موجود');
                    throw new Error('فشل في إنشاء زر تحميل PDF');
                }
                downloadBtn.addEventListener('click', async () => {
                    try {
                        console.log('بدء إنشاء ملف PDF');

                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: 'a4',
                        });

                        const sanitizeText = (text) => {
                            if (text === null || text === undefined || (typeof text === 'string' && text.trim() === '')) {
                                return 'غير متوفر';
                            }
                            if (typeof text === 'number') {
                                return text.toLocaleString('ar-IQ');
                            }
                            return String(text); // الاحتفاظ بالنص كما هو
                        };

                        const createSectionElement = (title, contentItems, isSubsection = false) => {
                            const section = document.createElement('div');
                            section.style.fontFamily = "'Amiri', Arial, sans-serif";
                            section.style.direction = 'rtl';
                            section.style.width = '754px';
                            section.style.padding = '15px';
                            section.style.background = '#FFF';
                            section.style.border = '2px solid #C19A6B';
                            section.style.boxSizing = 'border-box';
                            section.style.position = 'absolute';
                            section.style.left = '-9999px';
                            section.style.fontSize = '14px';
                            section.style.lineHeight = '1.6'; // تقليل تباعد الأسطر
                            section.style.margin = '10px';
                            section.style.overflow = 'visible';
                            section.style.display = 'block';
                            section.style.visibility = 'visible';
                            section.style.minHeight = '800px';

                            if (!isSubsection) {
                                const header = document.createElement('div');
                                header.style.background = '#9B2D30';
                                header.style.color = '#FFF';
                                header.style.padding = '12px';
                                header.style.textAlign = 'center';
                                header.style.borderBottom = '1px solid #C19A6B';
                                header.innerHTML = `
                                    <h1 style="font-size: 18px; margin: 3px 0;">${sanitizeText(title)}</h1>
                                    <p style="font-size: 13px; margin: 3px 0;">إعداد: ${sanitizeText(pdfData.companyInfo?.name) || 'غير متوفر'}</p>
                                    <p style="font-size: 13px; margin: 3px 0;">التاريخ: ${new Date().toLocaleDateString('ar-IQ')}</p>
                                `;
                                section.appendChild(header);
                            } else {
                                const titleEl = document.createElement('h3');
                                titleEl.style.fontSize = '14px';
                                titleEl.style.color = '#4B3C2E';
                                titleEl.style.marginBottom = '8px';
                                titleEl.textContent = sanitizeText(title);
                                section.appendChild(titleEl);
                                const hr = document.createElement('hr');
                                hr.style.border = '0.5px solid #C19A6B';
                                section.appendChild(hr);
                            }

                            const content = document.createElement('div');
                            content.style.margin = '10px';
                            content.style.padding = '10px';
                            content.style.background = '#FDF6E3';
                            content.style.borderRadius = '4px';

                            contentItems.forEach(item => {
                                const p = document.createElement('p');
                                p.style.display = 'flex';
                                p.style.alignItems = 'center';
                                p.style.margin = '6px 0'; // تقليل المسافة العمودية
                                p.style.padding = '6px'; // تقليل الحشوة
                                p.style.background = '#FFF';
                                p.style.borderRadius = '3px';
                                p.style.border = '1px solid #DBC2A4';
                                p.style.fontSize = '13px';

                                // فصل النص والقيمة
                                const parts = item.split(':').map(part => part.trim());
                                const label = parts[0] || '';
                                const valueAndUnit = parts[1] || '';
                                p.innerHTML = `
                                    <span style="min-width: 150px; text-align: right; margin-left: 10px;">${sanitizeText(label)}:</span>
                                    <span style="text-align: right;">${sanitizeText(valueAndUnit)}</span>
                                `;
                                content.appendChild(p);
                            });

                            section.appendChild(content);
                            console.log(`قسم "${title}": عدد العناصر = ${contentItems.length}`, contentItems);
                            return section;
                        };

                        const addSectionToPDF = async (sectionElement, sectionName) => {
                            console.log(`بدء إضافة قسم "${sanitizeText(sectionName)}"`);
                            document.body.appendChild(sectionElement);

                            await new Promise(resolve => setTimeout(resolve, 1000));

                            const canvas = await html2canvas(sectionElement, {
                                scale: 3,
                                useCORS: true,
                                logging: true,
                                windowWidth: 794,
                                windowHeight: sectionElement.scrollHeight + 800,
                                scrollX: 0,
                                scrollY: 0,
                                backgroundColor: '#FFF'
                            });
                            const imgData = canvas.toDataURL('image/jpeg', 0.95);
                            const imgWidth = 190;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            const pageHeight = 277 - 30;
                            let position = 0;

                            console.log(`قسم "${sanitizeText(sectionName)}": ارتفاع الصورة ${imgHeight.toFixed(2)} مم, عدد الصفحات المتوقع ${Math.ceil(imgHeight / pageHeight)}`);

                            doc.addPage();

                            while (position < imgHeight) {
                                const remainingHeight = Math.min(pageHeight, imgHeight - position);
                                console.log(`إضافة صورة لقسم "${sectionName}": إزاحة=${position.toFixed(2)} مم, ارتفاع=${remainingHeight.toFixed(2)} مم`);
                                doc.addImage(imgData, 'JPEG', 10, 10, imgWidth, remainingHeight, undefined, 'FAST');
                                position += remainingHeight;
                                if (position < imgHeight) {
                                    doc.addPage();
                                }
                            }
                            document.body.removeChild(sectionElement);
                        };

                        // إضافة الأقسام
                        const companyItems = [
                            `الاسم: ${sanitizeText(pdfData.companyInfo?.name)}`,
                            `الوصف: ${sanitizeText(pdfData.companyInfo?.description)}`,
                            `الهاتف: ${sanitizeText(pdfData.companyInfo?.contact?.phone)}`,
                            `البريد الإلكتروني: ${sanitizeText(pdfData.companyInfo?.contact?.email)}`,
                            `العنوان: ${sanitizeText(pdfData.companyInfo?.contact?.address)}`
                        ];
                        await addSectionToPDF(createSectionElement('معلومات الشركة', companyItems), 'معلومات الشركة');

                        const inputItems = [];
                        const addInputSection = (section, title) => {
                            if (section?.fields?.length > 0) {
                                inputItems.push(`--- ${sanitizeText(title)} ---`);
                                section.fields.forEach(field => {
                                    inputItems.push(`${sanitizeText(field.label)}: ${sanitizeText(field.value)}${field.unit ? ` ${sanitizeText(field.unit)}` : ''}`);
                                });
                            }
                        };
                        addInputSection(pdfData.inputData?.customer, pdfData.inputData?.customer?.title || 'بيانات العميل');
                        addInputSection(pdfData.inputData?.location, pdfData.inputData?.location?.title || 'معلومات الموقع');
                        addInputSection(pdfData.inputData?.land, pdfData.inputData?.land?.title || 'معلومات الأرض');
                        addInputSection(pdfData.inputData?.building, pdfData.inputData?.building?.title || 'تفاصيل المبنى');
                        await addSectionToPDF(createSectionElement('بيانات المدخلات', inputItems), 'بيانات المدخلات');

                        const quantitiesItems = [];
                        pdfData.quantities?.sections?.forEach(section => {
                            quantitiesItems.push(`--- ${sanitizeText(section.subtitle)} ---`);
                            section.items.forEach(item => {
                                quantitiesItems.push(`${sanitizeText(item.name)}: ${sanitizeText(item.value)} ${sanitizeText(item.unit || '')}`);
                            });
                        });
                        await addSectionToPDF(createSectionElement('تفاصيل الكميات الهندسية', quantitiesItems), 'تفاصيل الكميات الهندسية');

                        const engineeringItems = [];
                        pdfData.engineering?.sections?.forEach(section => {
                            engineeringItems.push(`--- ${sanitizeText(section.subtitle)} ---`);
                            section.items.forEach(item => {
                                engineeringItems.push(`${sanitizeText(item.name)}: ${sanitizeText(item.value)} ${sanitizeText(item.unit || '')}`);
                            });
                        });
                        await addSectionToPDF(createSectionElement('الحسابات الإنشائية', engineeringItems), 'الحسابات الإنشائية');

                        const costItems = [];
                        pdfData.costs?.items?.forEach(item => {
                            costItems.push(`${sanitizeText(item.name)}: ${sanitizeText(item.value)} ${sanitizeText(item.unit || '')}`);
                        });
                        if (pdfData.costs?.total) {
                            costItems.push(`الإجمالي: ${sanitizeText(pdfData.costs.total)} د.ع`);
                        }
                        await addSectionToPDF(createSectionElement('تفاصيل التكاليف', costItems), 'تفاصيل التكاليف');

                        const materialItems = [];
                        pdfData.materialPrices?.items?.forEach(item => {
                            materialItems.push(`${sanitizeText(item.name)}: ${sanitizeText(item.value)} ${sanitizeText(item.unit || '')}`);
                        });
                        await addSectionToPDF(createSectionElement('أسعار المواد المعتمدة (2025)', materialItems), 'أسعار المواد');

                        if (doc.internal.getNumberOfPages() > 0) {
                            doc.deletePage(1);
                        }

                        const finalPageCount = doc.internal.getNumberOfPages();
                        const footerElement = document.createElement('div');
                        footerElement.style.fontFamily = "'Amiri', Arial, sans-serif";
                        footerElement.style.direction = 'rtl';
                        footerElement.style.width = '754px';
                        footerElement.style.padding = '5px';
                        footerElement.style.position = 'absolute';
                        footerElement.style.left = '-9999px';
                        footerElement.style.fontSize = '10px';
                        footerElement.style.textAlign = 'right';
                        footerElement.style.background = '#FFF';
                        footerElement.style.display = 'block';
                        footerElement.style.visibility = 'visible';
                        for (let i = 1; i <= finalPageCount; i++) {
                            footerElement.textContent = `صفحة ${i} من ${finalPageCount} | ${sanitizeText(pdfData.companyInfo?.name) || 'غير متوفر'}`;
                            document.body.appendChild(footerElement);
                            const footerCanvas = await html2canvas(footerElement, {
                                scale: 3,
                                backgroundColor: '#FFF',
                                scrollX: 0,
                                scrollY: 0
                            });
                            const footerImgData = footerCanvas.toDataURL('image/jpeg', 0.95);
                            doc.setPage(i);
                            doc.addImage(footerImgData, 'JPEG', 10, 287 - 5, 190, (footerCanvas.height * 190) / footerCanvas.width);
                            document.body.removeChild(footerElement);
                        }

                        // فتح PDF في نافذة جديدة
                        const pdfDataUri = doc.output('datauristring');
                        const pdfWindow = window.open('', '_blank', 'noopener,noreferrer'); // إضافة خيارات للأمان
                        if (pdfWindow) {
                            pdfWindow.document.open();
                            pdfWindow.document.write(`
                                <html>
                                    <head>
                                        <title>تقرير_تكاليف_البناء_${new Date().toISOString().split('T')[0]}</title>
                                    </head>
                                    <body style="margin: 0;">
                                        <embed width="100%" height="100%" src="${pdfDataUri}" type="application/pdf">
                                    </body>
                                </html>
                            `);
                            pdfWindow.document.close();
                        } else {
                            console.error('فشل فتح النافذة الجديدة. تحقق من إعدادات حظر النوافذ المنبثقة في المتصفح.');
                            // الرجوع إلى التنزيل إذا فشل فتح النافذة
                            doc.save(`تقرير_تكاليف_البناء_${new Date().toISOString().split('T')[0]}.pdf`);
                        }

                        console.log(`تم إنشاء ملف PDF بـ ${finalPageCount} صفحات`);
                    } catch (error) {
                        console.error('خطأ أثناء إنشاء PDF:', error.stack);
                        const resultContent = document.getElementById('resultContent') || document.createElement('div');
                        resultContent.innerHTML = `<p style="color: #C75656;">خطأ في إنشاء PDF: ${error.message}.</p>`;
                        const resultContainer = document.getElementById('resultContainer') || document.createElement('div');
                        resultContainer.classList.remove('hidden');
                        resultContainer.style.display = 'block';
                        if (!document.getElementById('resultContainer')) document.body.appendChild(resultContainer);
                    }
                }, { once: true });
            } catch (error) {
                console.error('خطأ أثناء معالجة النموذج:', error);
                resultContent.innerHTML = `<p style="color: #C75656;">خطأ: ${error.message || 'حدث خطأ غير متوقع'}</p>`;
                resultContainer.classList.remove('hidden');
                resultContainer.style.display = 'block';
                submitBtn.innerHTML = '<span class="material-icons-outlined">calculate</span> حساب التكلفة';
                submitBtn.disabled = false;
                console.log('تم إعادة تعيين زر الإرسال');
            }
        });
    </script>
</body>
</html>
