<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حساب تكاليف البناء - العراق</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #5C4033; --accent: #E8B923; --background: #F5F1E9; --secondary-bg: #EDE7E0;
            --highlight: #A8C4A2; --text: #2A2A2A; --danger: #C75656; --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --border: #E4E2DB; --transparent-bg: rgba(255, 245, 235, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background: linear-gradient(135deg, #FFF6E6, #F5F1E9); color: var(--text); line-height: 1.5; overflow-x: hidden; }
        .container { max-width: 700px; margin: 15px auto; padding: 8px; }
        .language-selector select {
            padding: 4px 6px; font-size: 0.75rem; border-radius: 5px; border: 1px solid var(--border);
            background: var(--transparent-bg); cursor: pointer; transition: all 0.2s; max-width: 120px;
        }
        .language-selector select:focus { border-color: var(--accent); box-shadow: 0 0 3px rgba(232, 185, 35, 0.5); }
        .disclaimer {
            background: var(--transparent-bg); border-right: 3px solid var(--accent); padding: 8px; margin-bottom: 10px;
            border-radius: 5px; box-shadow: var(--shadow); backdrop-filter: blur(6px); animation: fadeIn 0.3s;
        }
        .disclaimer h2 { color: var(--danger); font-size: 0.85rem; margin-bottom: 3px; display: flex; align-items: center; gap: 4px; }
        .disclaimer p { font-size: 0.65rem; }
        .form-card { background: var(--secondary-bg); border-radius: 6px; box-shadow: var(--shadow); padding: 10px; margin-bottom: 12px; }
        .form-header { text-align: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
        .form-header h2 { color: var(--primary); font-size: 1.1rem; display: flex; justify-content: center; align-items: center; gap: 4px; }
        .form-header p { font-size: 0.6rem; }
        .form-section {
            margin-bottom: 8px; padding: 8px; background: var(--transparent-bg); border-radius: 5px;
            border-left: 3px solid var(--primary); transition: transform 0.2s, box-shadow 0.2s;
        }
        .form-section:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); }
        .form-section h3 { color: var(--primary); font-size: 0.95rem; margin-bottom: 5px; display: flex; align-items: center; gap: 4px; }
        .form-group { margin-bottom: 6px; position: relative; }
        .form-group label { display: block; margin-bottom: 2px; font-weight: 500; font-size: 0.7rem; }
        .form-control {
            width: 100%; padding: 4px 6px; border: 1px solid var(--border); border-radius: 4px;
            font-size: 0.75rem; background: var(--transparent-bg); transition: all 0.2s; height: 26px;
        }
        .form-control:focus { border-color: var(--accent); box-shadow: 0 0 6px rgba(232, 185, 35, 0.3); transform: scale(1.01); outline: none; }
        .form-control:invalid:focus { border-color: var(--danger); box-shadow: 0 0 6px rgba(199, 86, 86, 0.3); }
        .form-control.number-input, #customerName { text-align: left; direction: ltr; }
        .form-control.small-input { max-width: 120px; }
        .form-control.large-input { max-width: 200px; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
            position: relative;
            padding-right: 24px;
        }
        .number-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 200px;
        }
        .number-input-wrapper.small-input { max-width: 120px; }
        .number-input-buttons {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 20px;
        }
        .number-input-buttons button {
            flex: 1;
            background: var(--primary);
            color: #FFFFFF;
            border: none;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .number-input-buttons button:hover { background: var(--accent); }
        .number-input-buttons button:first-child { border-radius: 0 4px 0 0; }
        .number-input-buttons button:last-child { border-radius: 0 0 4px 0; }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin-bottom: 6px;
        }
        @media (max-width: 480px) {
            .form-row { grid-template-columns: 1fr; }
        }
        @media (min-width: 481px) and (max-width: 768px) {
            .form-row { grid-template-columns: repeat(2, 1fr); }
        }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 4px; font-weight: 500;
            padding: 6px 12px; font-size: 0.75rem; border-radius: 4px; border: none; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #D4A017); color: var(--text); }
        .btn-primary:hover { background: linear-gradient(135deg, #D4A017, var(--accent)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(232, 185, 35, 0.4); }
        .btn-reset { background: linear-gradient(135deg, var(--danger), #A13636); color: #FFFFFF; }
        .btn-reset:hover { background: linear-gradient(135deg, #A13636, var(--danger)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(199, 86, 86, 0.4); }
        .btn-block { width: 100%; max-width: 200px; }
        .hidden { display: none; }
        .toggle-section {
            background: var(--transparent-bg); padding: 6px; border-radius: 4px; margin-bottom: 5px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); transition: all 0.2s;
        }
        .toggle-section:hover { background: rgba(255, 245, 235, 0.98); transform: translateY(-1px); }
        .map-toggle { background: linear-gradient(135deg, var(--highlight), #8BAF7F); padding: 10px; font-size: 0.95rem; font-weight: 600; border-radius: 6px; box-shadow: 0 3px 10px rgba(168, 196, 162, 0.3); color: #FFFFFF; }
        .map-toggle:hover { background: linear-gradient(135deg, #8BAF7F, var(--highlight)); transform: translateY(-2px); }
        .toggle-content { padding: 6px; background: var(--transparent-bg); border-radius: 4px; margin-top: 4px; border: 1px solid var(--border); animation: fadeIn 0.3s; }
        .checkbox-group { display: flex; align-items: center; gap: 4px; margin-bottom: 5px; }
        .checkbox-group input { width: 12px; height: 12px; accent-color: var(--primary); }
        .result-container { margin-top: 10px; padding: 10px; background: linear-gradient(135deg, var(--primary), #7A5A45); border-radius: 6px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); color: #FFFFFF; display: none; animation: slideIn 0.3s; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-header h3 { font-size: 1rem; display: flex; align-items: center; gap: 4px; }
        .result-content table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .result-content th, .result-content td { padding: 6px; text-align: right; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-content th { background: rgba(255, 255, 255, 0.1); color: #FFFFFF; }
        .error-message { color: var(--danger); font-size: 0.6rem; margin-top: 2px; display: none; animation: fadeIn 0.2s; }
        .tooltip { position: absolute; background: var(--primary); color: #FFFFFF; padding: 2px 5px; border-radius: 4px; font-size: 0.6rem; top: -22px; right: 5px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .form-group:hover .tooltip { opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(6px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 768px) {
            .container { padding: 5px; }
            .form-card { padding: 8px; }
            .form-section { padding: 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-selector">
            <select id="languageSelect" class="form-control"><option value="ar">العربية</option></select>
        </div>
        <div class="disclaimer">
            <h2><span class="material-icons-outlined">warning</span> تنبيه قانوني</h2>
            <p>هذه الأداة مخصصة للأفراد في العراق فقط. يحظر استخدامها من قبل الشركات بدون تصريح. سيتم اتخاذ إجراءات قانونية ضد الاستخدام غير المرخص. الأداة مشفرة لحماية خوارزمياتها.</p>
        </div>
        <div class="form-card">
            <div class="form-header">
                <h2><span class="material-icons-outlined">calculate</span> حاسبة تكاليف البناء</h2>
                <p>أدخل تفاصيل المشروع لتقدير التكلفة</p>
            </div>
            <form id="buildingForm">
                <div class="form-section">
                    <h3><span class="material-icons-outlined">person</span> معلومات الزبون</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">الاسم الكامل</label>
                            <input type="text" id="customerName" class="form-control large-input" required pattern="[A-Za-z\u0600-\u06FF\s\-]{2,100}">
                            <div class="error-message" id="customerNameError">الاسم يجب أن يحتوي على أحرف ومسافات فقط (2-100 حرف)</div>
                            <span class="tooltip">أدخل الاسم الكامل</span>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">رقم الهاتف</label>
                            <input type="tel" id="phoneNumber" class="form-control large-input" required pattern="\+?[0-9\s\-]{7,15}">
                            <div class="error-message" id="phoneNumberError">أدخل رقم هاتف صالح (7-15 رقمًا)</div>
                            <span class="tooltip">أدخل رقم هاتف صالح</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">location_on</span> موقع الأرض</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="governorate">المحافظة</label>
                            <select id="governorate" class="form-control large-input" required>
                                <option value="">اختر المحافظة</option>
                                <option value="baghdad">بغداد</option><option value="basra">البصرة</option>
                                <option value="najaf">النجف</option><option value="karbala">كربلاء</option>
                                <option value="erbil">أربيل</option><option value="sulaymaniyah">السليمانية</option>
                                <option value="duhok">دهوك</option><option value="kirkuk">كركوك</option>
                                <option value="mosul">الموصل</option><option value="anbar">الأنبار</option>
                                <option value="saladin">صلاح الدين</option><option value="diyala">ديالى</option>
                                <option value="wasit">واسط</option><option value="babil">بابل</option>
                                <option value="qadisiyah">القادسية</option><option value="muthanna">المثنى</option>
                                <option value="dhi_qar">ذي قار</option><option value="maysan">ميسان</option>
                            </select>
                            <div class="error-message" id="governorateError">الرجاء اختيار المحافظة</div>
                            <span class="tooltip">اختر المحافظة</span>
                        </div>
                        <div class="form-group">
                            <label for="area">المنطقة/الحي</label>
                            <input type="text" id="area" class="form-control large-input" required pattern="[A-Za-z0-9\u0600-\u06FF\s\-\.]{3,100}">
                            <div class="error-message" id="areaError">المنطقة يجب أن تحتوي على أحرف وأرقام فقط (3-100 حرف)</div>
                            <span class="tooltip">حدد الحي أو المنطقة</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">square_foot</span> مواصفات الأرض</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="landArea">مساحة الأرض (م²)</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="landArea" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('landArea', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('landArea', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="landAreaError">أدخل مساحة بين 1 و999999999 (مرتبتين عشريتين)</div>
                            <span class="tooltip">أدخل مساحة الأرض</span>
                        </div>
                        <div class="form-group">
                            <label for="facadeWidth">عرض الواجهة (م)</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="facadeWidth" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('facadeWidth', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('facadeWidth', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="facadeWidthError">أدخل عرض بين 1 و999999999 (مرتبتين عشريتين)</div>
                            <span class="tooltip">أدخل عرض الواجهة</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">apartment</span> مواصفات البناء</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="floors">عدد الطوابق</label>
                            <div class="number-input-wrapper small-input">
                                <input type="number" id="floors" class="form-control number-input small-input" required min="1" max="99999" step="1">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('floors', 1)">+</button>
                                    <button type="button" onclick="stepNumber('floors', -1)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="floorsError">أدخل عدد صحيح بين 1 و99999</div>
                            <span class="tooltip">حدد عدد الطوابق</span>
                        </div>
                        <div class="form-group">
                            <label for="rooms">عدد الغرف</label>
                            <div class="number-input-wrapper small-input">
                                <input type="number" id="rooms" class="form-control number-input small-input" required min="1" max="99999" step="1">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('rooms', 1)">+</button>
                                    <button type="button" onclick="stepNumber('rooms', -1)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="roomsError">أدخل عدد صحيح بين 1 و99999</div>
                            <span class="tooltip">حدد عدد الغرف</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="groundFloorHeight">ارتفاع الطابق الأرضي (م)</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="groundFloorHeight" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('groundFloorHeight', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('groundFloorHeight', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="groundFloorHeightError">أدخل ارتفاع بين 1 و999999999 (مرتبتين عشريتين)</div>
                            <span class="tooltip">أدخل ارتفاع الطابق الأرضي</span>
                        </div>
                        <div class="form-group">
                            <label for="otherFloorsHeight">ارتفاع باقي الطوابق (م)</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="otherFloorsHeight" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('otherFloorsHeight', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('otherFloorsHeight', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="otherFloorsHeightError">أدخل ارتفاع بين 1 و999999999 (مرتبتين عشريتين)</div>
                            <span class="tooltip">أدخل ارتفاع باقي الطوابق</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bathrooms">عدد الحمامات</label>
                            <div class="number-input-wrapper small-input">
                                <input type="number" id="bathrooms" class="form-control number-input small-input" required min="1" max="99999" step="1">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('bathrooms', 1)">+</button>
                                    <button type="button" onclick="stepNumber('bathrooms', -1)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="bathroomsError">أدخل عدد صحيح بين 1 و99999</div>
                            <span class="tooltip">حدد عدد الحمامات</span>
                        </div>
                        <div class="form-group">
                            <label for="brickType">نوع الطابوق</label>
                            <select id="brickType" class="form-control large-input" required>
                                <option value="yellow">أصفر</option><option value="red">أحمر</option><option value="other">أخرى</option>
                            </select>
                            <span class="tooltip">اختر نوع الطابوق</span>
                        </div>
                    </div>
                    <div id="otherBrickInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="brickWidth">عرض البلوكة (سم)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="brickWidth" class="form-control number-input large-input" min="1" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('brickWidth', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('brickWidth', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="brickWidthError">أدخل عرض بين 1 و999999999</div>
                                <span class="tooltip">أدخل عرض البلوكة</span>
                            </div>
                            <div class="form-group">
                                <label for="brickLength">طول البلوكة (سم)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="brickLength" class="form-control number-input large-input" min="1" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('brickLength', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('brickLength', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="brickLengthError">أدخل طول بين 1 و999999999</div>
                                <span class="tooltip">أدخل طول البلوكة</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="brickHeight">ارتفاع البلوكة (سم)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="brickHeight" class="form-control number-input large-input" min="1" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('brickHeight', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('brickHeight', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="brickHeightError">أدخل ارتفاع بين 1 و999999999</div>
                                <span class="tooltip">أدخل ارتفاع البلوكة</span>
                            </div>
                            <div class="form-group">
                                <label for="brickDensity">كثافة البلوكة (كغم/م³)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="brickDensity" class="form-control number-input large-input" min="1" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('brickDensity', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('brickDensity', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="brickDensityError">أدخل كثافة بين 1 و999999999</div>
                                <span class="tooltip">أدخل كثافة البلوكة</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">attach_money</span> أسعار التشطيبات</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="flooringPrice">سعر م² تشطيبات الأرضيات</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="flooringPrice" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('flooringPrice', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('flooringPrice', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="flooringPriceError">أدخل سعر بين 1 و999999999</div>
                            <span class="tooltip">أدخل سعر الأرضيات</span>
                        </div>
                        <div class="form-group">
                            <label for="wallInstallationPrice">سعر م² تركيب الجدران</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="wallInstallationPrice" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('wallInstallationPrice', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('wallInstallationPrice', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="wallInstallationPriceError">أدخل سعر بين 1 و999999999</div>
                            <span class="tooltip">أدخل سعر الجدران</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="wallPaintingPrice">سعر م² صبغ الجدران</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="wallPaintingPrice" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('wallPaintingPrice', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('wallPaintingPrice', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="wallPaintingPriceError">أدخل سعر بين 1 و999999999</div>
                            <span class="tooltip">أدخل سعر صبغ الجدران</span>
                        </div>
                        <div class="form-group">
                            <label for="windowsDoorsPrice">سعر م² شبابيك وأبواب</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="windowsDoorsPrice" class="form-control number-input large-input" required min="1" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('windowsDoorsPrice', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('windowsDoorsPrice', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="windowsDoorsPriceError">أدخل سعر بين 1 و999999999</div>
                            <span class="tooltip">أدخل سعر الشبابيك</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">build</span> خيارات إضافية</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="woodType">نوع الخشب</label>
                            <select id="woodType" class="form-control large-input" required>
                                <option value="plywood">بليوود</option><option value="regular">عادي</option><option value="waffle">Waffle Slab</option>
                            </select>
                            <span class="tooltip">اختر نوع الخشب</span>
                        </div>
                        <div class="form-group">
                            <label for="facadeType">نوع الواجهة</label>
                            <select id="facadeType" class="form-control large-input" required>
                                <option value="economy">اقتصادية</option><option value="simple">تفاصيل بسيطة</option>
                                <option value="luxury">فخمة</option><option value="custom">مخصصة</option>
                            </select>
                            <span class="tooltip">اختر نوع الواجهة</span>
                        </div>
                    </div>
                    <div id="customFacadeInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="facadeArea">مساحة الواجهة المخصصة (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="facadeArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('facadeArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('facadeArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="facadeAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الواجهة</span>
                            </div>
                            <div class="form-group">
                                <label for="facadePrice">سعر م² الواجهة</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="facadePrice" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('facadePrice', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('facadePrice', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="facadePriceError">أدخل سعر بين 0 و999999999</div>
                                <span class="tooltip">أدخل سعر الواجهة</span>
                            </div>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleApartments">
                        <span><span class="material-icons-outlined">apartment</span> شقق سكنية</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="apartmentsInfo" class="toggle-content hidden">
                        <div class="form-group">
                            <label for="apartmentsCount">عدد الشقق</label>
                            <div class="number-input-wrapper small-input">
                                <input type="number" id="apartmentsCount" class="form-control number-input small-input" min="0" max="99999" step="1">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('apartmentsCount', 1)">+</button>
                                    <button type="button" onclick="stepNumber('apartmentsCount', -1)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="apartmentsCountError">أدخل عدد صحيح بين 0 و99999</div>
                            <span class="tooltip">حدد عدد الشقق</span>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleBasement">
                        <span><span class="material-icons-outlined">garage</span> طوابق سفلية</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="basementInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="basementFloors">عدد الطوابق السفلية</label>
                                <div class="number-input-wrapper small-input">
                                    <input type="number" id="basementFloors" class="form-control number-input small-input" min="0" max="99999" step="1">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('basementFloors', 1)">+</button>
                                        <button type="button" onclick="stepNumber('basementFloors', -1)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="basementFloorsError">أدخل عدد صحيح بين 0 و99999</div>
                                <span class="tooltip">حدد عدد الطوابق السفلية</span>
                            </div>
                            <div class="form-group">
                                <label for="basementCeilingArea">مساحة السقوف (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="basementCeilingArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('basementCeilingArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('basementCeilingArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="basementCeilingAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="basementPrice">سعر م² الطوابق السفلية</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="basementPrice" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('basementPrice', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('basementPrice', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="basementPriceError">أدخل سعر بين 0 و999999999</div>
                            <span class="tooltip">أدخل سعر الطوابق السفلية</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">home</span> المرافق</h3>
                    <div class="form-row">
                        <div class="checkbox-group"><input type="checkbox" id="hasGarden"><label for="hasGarden"><span class="material-icons-outlined">yard</span> حديقة</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasPool"><label for="hasPool"><span class="material-icons-outlined">pool</span> مسبح</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasHVAC"><label for="hasHVAC"><span class="material-icons-outlined">ac_unit</span> تدفئة وتبريد</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasElevator"><label for="hasElevator"><span class="material-icons-outlined">elevator</span> مصعد</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasFence"><label for="hasFence"><span class="material-icons-outlined">fence</span> سياج</label></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="toggle-section map-toggle" id="toggleMapDetails">
                        <span><span class="material-icons-outlined">map</span> تفاصيل الخريطة</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="mapDetailsInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="totalRoofArea">مساحة السقوف الكلية (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="totalRoofArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('totalRoofArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('totalRoofArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="totalRoofAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                            <div class="form-group">
                                <label for="gardenArea">مساحة الحديقة (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="gardenArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('gardenArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('gardenArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="gardenAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الحديقة</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="garagePathArea">مساحة الكراج والممرات (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="garagePathArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('garagePathArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('garagePathArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="garagePathAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الكراج</span>
                            </div>
                            <div class="form-group">
                                <label for="externalPlasterWalls">مساحة الجدران الخارجية (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="externalPlasterWalls" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('externalPlasterWalls', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('externalPlasterWalls', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="externalPlasterWallsError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="skylightsArea">مساحة المناور (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="skylightsArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('skylightsArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('skylightsArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="skylightsAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة المناور</span>
                            </div>
                            <div class="form-group">
                                <label for="tiesLength">طول الرباطات (م)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="tiesLength" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('tiesLength', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('tiesLength', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="tiesLengthError">أدخل طول بين 0 و999999999</div>
                                <span class="tooltip">أدخل طول الرباطات</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invertedBeams">طول الجسور المقلوبة (م)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="invertedBeams" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('invertedBeams', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('invertedBeams', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="invertedBeamsError">أدخل طول بين 0 و999999999</div>
                                <span class="tooltip">أدخل طول الجسور</span>
                            </div>
                            <div class="form-group">
                                <label for="externalWalls24cm">أطوال الجدران الخارجية 24سم (م)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="externalWalls24cm" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('externalWalls24cm', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('externalWalls24cm', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="externalWalls24cmError">أدخل طول بين 0 و999999999</div>
                                <span class="tooltip">أدخل طول الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="internalWalls24cm">أطوال الجدران الداخلية 24سم (م)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="internalWalls24cm" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('internalWalls24cm', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('internalWalls24cm', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="internalWalls24cmError">أدخل طول بين 0 و999999999</div>
                                <span class="tooltip">أدخل طول الجدران</span>
                            </div>
                            <div class="form-group">
                                <label for="roofFenceLength">طول ستارة السطح (م)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="roofFenceLength" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('roofFenceLength', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('roofFenceLength', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="roofFenceLengthError">أدخل طول بين 0 و999999999</div>
                                <span class="tooltip">أدخل طول السياج</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="externalDoors">عدد الأبواب الخارجية</label>
                                <div class="number-input-wrapper small-input">
                                    <input type="number" id="externalDoors" class="form-control number-input small-input" min="0" max="99999" step="1">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('externalDoors', 1)">+</button>
                                        <button type="button" onclick="stepNumber('externalDoors', -1)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="externalDoorsError">أدخل عدد صحيح بين 0 و99999</div>
                                <span class="tooltip">حدد عدد الأبواب</span>
                            </div>
                            <div class="form-group">
                                <label for="internalDoors">عدد الأبواب الداخلية</label>
                                <div class="number-input-wrapper small-input">
                                    <input type="number" id="internalDoors" class="form-control number-input small-input" min="0" max="99999" step="1">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('internalDoors', 1)">+</button>
                                        <button type="button" onclick="stepNumber('internalDoors', -1)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="internalDoorsError">أدخل عدد صحيح بين 0 و99999</div>
                                <span class="tooltip">حدد عدد الأبواب</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="facadeWindowsDoorsArea">مساحة شبابيك وأبواب الواجهة (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="facadeWindowsDoorsArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('facadeWindowsDoorsArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('facadeWindowsDoorsArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="facadeWindowsDoorsAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الشبابيك</span>
                            </div>
                            <div class="form-group">
                                <label for="skylightWindowsDoorsArea">مساحة شبابيك المناور (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="skylightWindowsDoorsArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('skylightWindowsDoorsArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('skylightWindowsDoorsArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="skylightWindowsDoorsAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة المناور</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="secondaryCeilingsArea">مساحة السقوف الثانوية (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="secondaryCeilingsArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('secondaryCeilingsArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('secondaryCeilingsArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="secondaryCeilingsAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                            <div class="form-group">
                                <label for="decorativeWallsArea">مساحة الجدران الديكورية (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="decorativeWallsArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('decorativeWallsArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('decorativeWallsArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="decorativeWallsAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="claddingWallsArea">مساحة الجدران التغليف (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="claddingWallsArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('claddingWallsArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('claddingWallsArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="claddingWallsAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                        </div>
                        <div class="toggle-section" id="toggleStairsRailing">
                            <span><span class="material-icons-outlined">stairs</span> محجر الدرج</span>
                            <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                        </div>
                        <div id="stairsRailingInfo" class="toggle-content hidden">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="stairsRailingLength">طول محجر الدرج (م)</label>
                                    <div class="number-input-wrapper large-input">
                                        <input type="number" id="stairsRailingLength" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                        <div class="number-input-buttons">
                                            <button type="button" onclick="stepNumber('stairsRailingLength', 0.01)">+</button>
                                            <button type="button" onclick="stepNumber('stairsRailingLength', -0.01)">-</button>
                                        </div>
                                    </div>
                                    <div class="error-message" id="stairsRailingLengthError">أدخل طول بين 0 و999999999</div>
                                    <span class="tooltip">أدخل طول محجر الدرج</span>
                                </div>
                                <div class="form-group">
                                    <label for="stairsRailingPrice">سعر المتر الطولي</label>
                                    <div class="number-input-wrapper large-input">
                                        <input type="number" id="stairsRailingPrice" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                        <div class="number-input-buttons">
                                            <button type="button" onclick="stepNumber('stairsRailingPrice', 0.01)">+</button>
                                            <button type="button" onclick="stepNumber('stairsRailingPrice', -0.01)">-</button>
                                        </div>
                                    </div>
                                    <div class="error-message" id="stairsRailingPriceError">أدخل سعر بين 0 و999999999</div>
                                    <span class="tooltip">أدخل سعر محجر الدرج</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleConcreteColumns">
                        <span><span class="material-icons-outlined">foundation</span> أعمدة كونكريت</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="concreteColumnsInfo" class="toggle-content hidden">
                        <div class="form-group">
                            <label for="concreteVolume">حجم الكونكريت (م³)</label>
                            <div class="number-input-wrapper large-input">
                                <input type="number" id="concreteVolume" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                <div class="number-input-buttons">
                                    <button type="button" onclick="stepNumber('concreteVolume', 0.01)">+</button>
                                    <button type="button" onclick="stepNumber('concreteVolume', -0.01)">-</button>
                                </div>
                            </div>
                            <div class="error-message" id="concreteVolumeError">أدخل حجم بين 0 و999999999</div>
                            <span class="tooltip">أدخل حجم الكونكريت</span>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleInternalWalls">
                        <span><span class="material-icons-outlined">wallpaper</span> جدران داخلية</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="internalWallsInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="internalWallsArea">مساحة الجدران (م²)</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="internalWallsArea" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('internalWallsArea', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('internalWallsArea', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="internalWallsAreaError">أدخل مساحة بين 0 و999999999</div>
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                            <div class="form-group">
                                <label for="internalWallsPrice">سعر م² الجدران</label>
                                <div class="number-input-wrapper large-input">
                                    <input type="number" id="internalWallsPrice" class="form-control number-input large-input" min="0" max="999999999" step="0.01">
                                    <div class="number-input-buttons">
                                        <button type="button" onclick="stepNumber('internalWallsPrice', 0.01)">+</button>
                                        <button type="button" onclick="stepNumber('internalWallsPrice', -0.01)">-</button>
                                    </div>
                                </div>
                                <div class="error-message" id="internalWallsPriceError">أدخل سعر بين 0 و999999999</div>
                                <span class="tooltip">أدخل سعر الجدران</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block" id="submitBtn"><span class="material-icons-outlined">calculate</span> حساب التكلفة</button>
                    </div>
                    <div class="form-group">
                        <button type="reset" class="btn btn-reset btn-block"><span class="material-icons-outlined">refresh</span> إعادة تعيين</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="resultContainer" class="result-container" style="display: none;">
            <div class="result-header">
                <h3><span class="material-icons-outlined">assessment</span> نتيجة الحساب</h3>
            </div>
            <div id="resultContent" class="result-content"></div>
            <button id="downloadPdf" class="btn btn-primary btn-block"><span class="material-icons-outlined">picture_as_pdf</span> تحميل PDF</button>
        </div>
    </div>
    <script>
        // دالة تنظيف المدخل
        const sanitizeInput = (value) => {
            if (typeof value !== 'string') return value;
            return value.replace(/[<>"]/g, '').trim();
        };

        // دالة التحقق من الأعداد الكسرية
        const validateDecimal = (value, min, max) => {
            const num = parseFloat(value);
            const regex = /^\d*(\.\d{1,2})?$/;
            return !isNaN(num) && num >= min && num <= max && regex.test(value.toString());
        };

        // دالة التحقق من الأعداد الصحيحة
        const validateInteger = (value, min, max) => {
            const num = parseInt(value);
            return !isNaN(num) && Number.isInteger(num) && num >= min && num <= max;
        };

        // دالة التحقق من النصوص
        const validateText = (value, regex, minLength, maxLength) => {
            return regex.test(value) && value.length >= minLength && value.length <= maxLength;
        };

        // دالة لزيادة/تقليل القيمة
        function stepNumber(id, step) {
            const input = document.getElementById(id);
            const current = parseFloat(input.value) || 0;
            const min = parseFloat(input.min) || 0;
            const max = parseFloat(input.max) || Infinity;
            let newValue = current + step;
            if (newValue >= min && newValue <= max) {
                input.value = step === 1 ? Math.round(newValue) : newValue.toFixed(2);
                validateInput(input);
            }
        }

        // إعداد الأقسام القابلة للطي
        const toggles = [
            { toggle: 'toggleApartments', content: 'apartmentsInfo' },
            { toggle: 'toggleBasement', content: 'basementInfo' },
            { toggle: 'toggleMapDetails', content: 'mapDetailsInfo' },
            { toggle: 'toggleStairsRailing', content: 'stairsRailingInfo' },
            { toggle: 'toggleConcreteColumns', content: 'concreteColumnsInfo' },
            { toggle: 'toggleInternalWalls', content: 'internalWallsInfo' }
        ];
        toggles.forEach(({ toggle, content }) => {
            const t = document.getElementById(toggle);
            const c = document.getElementById(content);
            if (t && c) {
                t.addEventListener('click', () => {
                    c.classList.toggle('hidden');
                    t.querySelector('.toggle-icon span').textContent = c.classList.contains('hidden') ? 'add' : 'remove';
                });
            }
        });

        // دالة للتحكم بالقوائم المنسدلة
        const toggleSelect = (selectId, contentId, triggerValue) => {
            const select = document.getElementById(selectId);
            const content = document.getElementById(contentId);
            if (select && content) {
                select.addEventListener('change', () => {
                    content.classList.toggle('hidden', select.value !== triggerValue);
                    content.querySelectorAll('input').forEach(input => {
                        input.required = select.value === triggerValue;
                    });
                });
            }
        };

        toggleSelect('brickType', 'otherBrickInfo', 'other');
        toggleSelect('facadeType', 'customFacadeInfo', 'custom');

        // دالة التحقق من المدخلات
        function validateInput(input) {
            const errorElement = document.getElementById(`${input.id}Error`);
            let isValid = true;
            if (input.type === 'text' || input.type === 'tel') {
                isValid = validateText(sanitizeInput(input.value), new RegExp(input.pattern), input.minLength || 0, input.maxLength || Infinity);
            } else if (input.type === 'number') {
                const min = parseFloat(input.min) || 0;
                const max = parseFloat(input.max) || Infinity;
                isValid = input.step === '1' ? validateInteger(input.value, min, max) : validateDecimal(input.value, min, max);
            } else if (input.tagName === 'SELECT') {
                isValid = input.value !== '';
            }
            if (errorElement) errorElement.style.display = isValid || !input.required ? 'none' : 'block';
            return isValid;
        }

        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('input', () => validateInput(input));
            input.addEventListener('blur', () => validateInput(input));
        });

        // معالجة تقديم النموذج
        document.getElementById('buildingForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'جارٍ الحساب...';

            const inputs = document.querySelectorAll('.form-control');
            let isValid = true;

            inputs.forEach(input => {
                if (input.required && !validateInput(input)) isValid = false;
            });

            if (!isValid) {
                alert('يرجى تصحيح الأخطاء في النموذج');
                submitBtn.innerHTML = '<span class="material-icons-outlined">calculate</span> حساب التكلفة';
                submitBtn.disabled = false;
                return;
            }

            const data = {
                customerName: sanitizeInput(document.getElementById('customerName').value),
                phoneNumber: sanitizeInput(document.getElementById('phoneNumber').value),
                governorate: document.getElementById('governorate').value,
                area: sanitizeInput(document.getElementById('area').value),
                landArea: parseFloat(document.getElementById('landArea').value) || 0,
                facadeWidth: parseFloat(document.getElementById('facadeWidth').value) || 0,
                floors: parseInt(document.getElementById('floors').value) || 1,
                rooms: parseInt(document.getElementById('rooms').value) || 0,
                groundFloorHeight: parseFloat(document.getElementById('groundFloorHeight').value) || 0,
                otherFloorsHeight: parseFloat(document.getElementById('otherFloorsHeight').value) || 0,
                bathrooms: parseInt(document.getElementById('bathrooms').value) || 0,
                brickType: document.getElementById('brickType').value,
                brickWidth: parseFloat(document.getElementById('brickWidth').value) || 0,
                brickLength: parseFloat(document.getElementById('brickLength').value) || 0,
                brickHeight: parseFloat(document.getElementById('brickHeight').value) || 0,
                brickDensity: parseFloat(document.getElementById('brickDensity').value) || 0,
                flooringPrice: parseFloat(document.getElementById('flooringPrice').value) || 0,
                wallInstallationPrice: parseFloat(document.getElementById('wallInstallationPrice').value) || 0,
                wallPaintingPrice: parseFloat(document.getElementById('wallPaintingPrice').value) || 0,
                windowsDoorsPrice: parseFloat(document.getElementById('windowsDoorsPrice').value) || 0,
                woodType: document.getElementById('woodType').value,
                facadeType: document.getElementById('facadeType').value,
                facadeArea: parseFloat(document.getElementById('facadeArea').value) || 0,
                facadePrice: parseFloat(document.getElementById('facadePrice').value) || 0,
                apartmentsCount: parseInt(document.getElementById('apartmentsCount').value) || 0,
                basementFloors: parseInt(document.getElementById('basementFloors').value) || 0,
                basementCeilingArea: parseFloat(document.getElementById('basementCeilingArea').value) || 0,
                basementPrice: parseFloat(document.getElementById('basementPrice').value) || 0,
                hasGarden: document.getElementById('hasGarden').checked,
                hasPool: document.getElementById('hasPool').checked,
                hasHVAC: document.getElementById('hasHVAC').checked,
                hasElevator: document.getElementById('hasElevator').checked,
                hasFence: document.getElementById('hasFence').checked,
                totalRoofArea: parseFloat(document.getElementById('totalRoofArea').value) || 0,
                gardenArea: parseFloat(document.getElementById('gardenArea').value) || 0,
                garagePathArea: parseFloat(document.getElementById('garagePathArea').value) || 0,
                externalPlasterWalls: parseFloat(document.getElementById('externalPlasterWalls').value) || 0,
                skylightsArea: parseFloat(document.getElementById('skylightsArea').value) || 0,
                tiesLength: parseFloat(document.getElementById('tiesLength').value) || 0,
                invertedBeams: parseFloat(document.getElementById('invertedBeams').value) || 0,
                externalWalls24cm: parseFloat(document.getElementById('externalWalls24cm').value) || 0,
                internalWalls24cm: parseFloat(document.getElementById('internalWalls24cm').value) || 0,
                roofFenceLength: parseFloat(document.getElementById('roofFenceLength').value) || 0,
                externalDoors: parseInt(document.getElementById('externalDoors').value) || 0,
                internalDoors: parseInt(document.getElementById('internalDoors').value) || 0,
                facadeWindowsDoorsArea: parseFloat(document.getElementById('facadeWindowsDoorsArea').value) || 0,
                skylightWindowsDoorsArea: parseFloat(document.getElementById('skylightWindowsDoorsArea').value) || 0,
                secondaryCeilingsArea: parseFloat(document.getElementById('secondaryCeilingsArea').value) || 0,
                decorativeWallsArea: parseFloat(document.getElementById('decorativeWallsArea').value) || 0,
                claddingWallsArea: parseFloat(document.getElementById('claddingWallsArea').value) || 0,
                stairsRailingLength: parseFloat(document.getElementById('stairsRailingLength').value) || 0,
                stairsRailingPrice: parseFloat(document.getElementById('stairsRailingPrice').value) || 0,
                concreteVolume: parseFloat(document.getElementById('concreteVolume').value) || 0,
                internalWallsArea: parseFloat(document.getElementById('internalWallsArea').value) || 0,
                internalWallsPrice: parseFloat(document.getElementById('internalWallsPrice').value) || 0
            };

            try {
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`خطأ في الاتصال: ${response.status}`);
                }

                const result = await response.json();
                const resultContainer = document.getElementById('resultContainer');
                const resultContent = document.getElementById('resultContent');
                resultContent.innerHTML = `
                    <div class="result-section" id="pdfContent">
                        <h3>النتائج</h3>
                        <table>
                            <tr><th>البيان</th><th>القيمة</th></tr>
                            <tr><td>الرسالة</td><td>${sanitizeInput(result.result.message)}</td></tr>
                            <tr><td>البيانات المدخلة</td><td><pre>${sanitizeInput(JSON.stringify(result.result.inputData, null, 2))}</pre></td></tr>
                        </table>
                    </div>
                `;
                resultContainer.style.display = 'block';

                // إزالة أي مستمع سابق لزر PDF
                const downloadBtn = document.getElementById('downloadPdf');
                downloadBtn.onclick = null;
                downloadBtn.addEventListener('click', () => {
                    const pdfContent = document.getElementById('pdfContent').innerHTML;
                    const pdfWindow = window.open('', '_blank');
                    pdfWindow.document.write(`
                        <html dir="ar">
                        <head>
                            <title>تقرير تكاليف البناء</title>
                            <style>
                                @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500&display=swap');
                                body { font-family: 'Tajawal', sans-serif; padding: 10px; background: #F5F1E9; color: #2A2A2A; }
                                h3 { color: #5C4033; font-size: 1.5rem; }
                                table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
                                th, td { padding: 8px; text-align: right; border-bottom: 1px solid #E4E2DB; }
                                th { background: rgba(92, 64, 51, 0.1); color: #5C4033; }
                                pre { white-space: pre-wrap; background: rgba(255, 245, 235, 0.95); padding: 8px; border-radius: 4px; }
                            </style>
                        </head>
                        <body>${pdfContent}</body>
                    </html>
                    `);
                    pdfWindow.document.close();
                    setTimeout(() => pdfWindow.print(), 500);
                });
            } catch (error) {
                document.getElementById('resultContent').innerHTML = `<p style="error-message">خطأ: ${sanitizeInput(error.message)}</p>`;
                document.getElementById('resultContainer').style.display = 'block';
            } finally {
                submitBtn.innerHTML = '<span class="material-icons-outlined">calculate</span> حساب التكلفة';
                submitBtn.disabled = false;
            }
        });

        // إعادة تعيين النموذج
        document.getElementById('buildingForm').addEventListener('reset', () => {
            document.getElementById('resultContainer').style.display = 'none';
            document.querySelectorAll('.error-message').forEach(error => error.style.display = 'none');
            document.querySelectorAll('.toggle-content').forEach(content => content.classList.add('hidden'));
            document.querySelectorAll('.toggle-icon span').forEach(icon => icon.textContent = 'add');
        });
    </script>
</body>
</html>
