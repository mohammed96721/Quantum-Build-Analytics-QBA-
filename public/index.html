<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حساب تكاليف البناء - العراق</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <!-- إضافة مكتبات jsPDF و jsPDF-autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #5C4033; --accent: #E8B923; --background: #F5F1E9; --secondary-bg: #EDE7E0;
            --highlight: #A8C4A2; --text: #2A2A2A; --danger: #C75656; --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --border: #E4E2DB; --transparent-bg: rgba(255, 245, 235, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background: linear-gradient(135deg, #FFF6E6, #F5F1E9); color: var(--text); line-height: 1.5; overflow-x: hidden; }
        .container { max-width: 700px; margin: 15px auto; padding: 8px; }
        .language-selector select {
            padding: 4px 6px; font-size: 0.75rem; border-radius: 5px; border: 1px solid var(--border);
            background: var(--transparent-bg); cursor: pointer; transition: all 0.2s; max-width: 120px;
        }
        .language-selector select:focus { border-color: var(--accent); box-shadow: 0 0 3px rgba(232, 185, 35, 0.5); }
        .disclaimer {
            background: var(--transparent-bg); border-right: 3px solid var(--accent); padding: 8px; margin-bottom: 10px;
            border-radius: 5px; box-shadow: var(--shadow); backdrop-filter: blur(6px); animation: fadeIn 0.3s;
        }
        .disclaimer h2 { color: var(--danger); font-size: 0.85rem; margin-bottom: 3px; display: flex; align-items: center; gap: 4px; }
        .disclaimer p { font-size: 0.65rem; }
        .form-card { background: var(--secondary-bg); border-radius: 6px; box-shadow: var(--shadow); padding: 10px; margin-bottom: 12px; }
        .form-header { text-align: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
        .form-header h2 { color: var(--primary); font-size: 1.1rem; display: flex; justify-content: center; align-items: center; gap: 4px; }
        .form-header p { font-size: 0.6rem; }
        .form-section {
            margin-bottom: 8px; padding: 8px; background: var(--transparent-bg); border-radius: 5px;
            border-left: 3px solid var(--primary); transition: transform 0.2s, box-shadow 0.2s;
        }
        .form-section:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); }
        .form-section h3 { color: var(--primary); font-size: 0.95rem; margin-bottom: 5px; display: flex; align-items: center; gap: 4px; }
        .form-group { margin-bottom: 6px; position: relative; }
        .form-group label { display: block; margin-bottom: 2px; font-weight: 500; font-size: 0.7rem; }
        .form-control {
            width: 100%; max-width: 200px; padding: 4px 6px; border: 1px solid var(--border); border-radius: 5px;
            font-size: 0.75rem; background: var(--transparent-bg); transition: all 0.2s; height: 26px;
            text-align: left;
        }
        .form-control:focus { border-color: var(--accent); box-shadow: 0 0 6px rgba(232, 185, 35, 0.3); transform: scale(1.01); outline: none; }
        .form-control:invalid:focus { border-color: var(--danger); box-shadow: 0 0 6px rgba(199, 86, 86, 0.3); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 6px; }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 4px; font-weight: 500;
            padding: 6px 12px; font-size: 0.75rem; border-radius: 5px; border: none; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #D4A017); color: var(--text); }
        .btn-primary:hover { background: linear-gradient(135deg, #D4A017, var(--accent)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(232, 185, 35, 0.4); }
        .btn-reset { background: linear-gradient(135deg, var(--danger), #A13636); color: #FFFFFF; }
        .btn-reset:hover { background: linear-gradient(135deg, #A13636, var(--danger)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(199, 86, 86, 0.4); }
        .btn-block { width: 100%; max-width: 200px; }
        .hidden { display: none; }
        .toggle-section {
            background: var(--transparent-bg); padding: 6px; border-radius: 5px; margin-bottom: 5px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); transition: all 0.2s;
        }
        .toggle-section:hover { background: rgba(255, 245, 235, 0.98); transform: translateY(-1px); }
        .map-toggle { background: linear-gradient(135deg, var(--highlight), #8BAF7F); padding: 10px; font-size: 0.95rem; font-weight: 600; border-radius: 6px; box-shadow: 0 3px 10px rgba(168, 196, 162, 0.3); color: #FFFFFF; }
        .map-toggle:hover { background: linear-gradient(135deg, #8BAF7F, var(--highlight)); transform: translateY(-2px); }
        .toggle-content { padding: 6px; background: var(--transparent-bg); border-radius: 5px; margin-top: 4px; border: 1px solid var(--border); animation: fadeIn 0.3s; }
        .checkbox-group { display: flex; align-items: center; gap: 4px; margin-bottom: 5px; }
        .checkbox-group input { width: 12px; height: 12px; accent-color: var(--primary); }
        .result-container { margin-top: 10px; padding: 10px; background: linear-gradient(135deg, var(--primary), #7A5A45); border-radius: 6px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); color: #FFFFFF; display: none; animation: slideIn 0.3s; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-header h3 { font-size: 1rem; display: flex; align-items: center; gap: 4px; }
        .result-content table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .result-content th, .result-content td { padding: 6px; text-align: right; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-content th { background: rgba(255, 255, 255, 0.1); color: #FFFFFF; }
        .error-message { color: var(--danger); font-size: 0.6rem; margin-top: 2px; display: none; animation: fadeIn 0.2s; }
        .tooltip { position: absolute; background: var(--primary); color: #FFFFFF; padding: 2px 5px; border-radius: 4px; font-size: 0.6rem; top: -22px; right: 5px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .form-group:hover .tooltip { opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(6px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .form-control, .btn-block { max-width: 100%; }
            .container { padding: 5px; }
            .form-card { padding: 8px; }
            .form-section { padding: 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-selector">
            <select id="languageSelect" class="form-control"><option value="ar">العربية</option></select>
        </div>
        <div class="disclaimer">
            <h2><span class="material-icons-outlined">warning</span> تنبيه قانوني</h2>
            <p>هذه الأداة مخصصة للأفراد في العراق فقط. يحظر استخدامها من قبل الشركات بدون تصريح. سيتم اتخاذ إجراءات قانونية ضد الاستخدام غير المرخص. الأداة مشفرة لحماية خوارزمياتها.</p>
        </div>
        <div class="form-card">
            <div class="form-header">
                <h2><span class="material-icons-outlined">calculate</span> حاسبة تكاليف البناء</h2>
                <p>أدخل تفاصيل المشروع لتقدير التكلفة</p>
            </div>
            <form id="buildingForm">
                <div class="form-section">
                    <h3><span class="material-icons-outlined">person</span> معلومات الزبون</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="customerName">الاسم الكامل</label>
                            <input type="text" id="customerName" class="form-control" required>
                            <div class="error-message" id="customerNameError">الرجاء إدخال الاسم</div>
                            <span class="tooltip">أدخل الاسم الكامل</span>
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">رقم الهاتف</label>
                            <input type="tel" id="phoneNumber" class="form-control" required>
                            <div class="error-message" id="phoneNumberError">الرجاء إدخال رقم هاتف</div>
                            <span class="tooltip">أدخل رقم هاتف صالح</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">location_on</span> موقع الأرض</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="governorate">المحافظة</label>
                            <select id="governorate" class="form-control" required>
                                <option value="">اختر المحافظة</option>
                                <option value="baghdad">بغداد</option><option value="basra">البصرة</option>
                                <option value="najaf">النجف</option><option value="karbala">كربلاء</option>
                                <option value="erbil">أربيل</option><option value="sulaymaniyah">السليمانية</option>
                                <option value="duhok">دهوك</option><option value="kirkuk">كركوك</option>
                                <option value="mosul">الموصل</option><option value="anbar">الأنبار</option>
                                <option value="saladin">صلاح الدين</option><option value="diyala">ديالى</option>
                                <option value="wasit">واسط</option><option value="babil">بابل</option>
                                <option value="qadisiyah">القادسية</option><option value="muthanna">المثنى</option>
                                <option value="dhi_qar">ذي قار</option><option value="maysan">ميسان</option>
                            </select>
                            <div class="error-message" id="governorateError">الرجاء اختيار المحافظة</div>
                            <span class="tooltip">اختر المحافظة</span>
                        </div>
                        <div class="form-group">
                            <label for="area">المنطقة/الحي</label>
                            <input type="text" id="area" class="form-control" required>
                            <div class="error-message" id="areaError">الرجاء إدخال المنطقة</div>
                            <span class="tooltip">حدد الحي أو المنطقة</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">square_foot</span> مواصفات الأرض</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="landArea">مساحة الأرض (م²)</label>
                            <input type="number" id="landArea" class="form-control" required step="0.01">
                            <div class="error-message" id="landAreaError">الرجاء إدخال مساحة</div>
                            <span class="tooltip">أدخل مساحة الأرض</span>
                        </div>
                        <div class="form-group">
                            <label for="facadeWidth">عرض الواجهة (م)</label>
                            <input type="number" id="facadeWidth" class="form-control" required step="0.01">
                            <div class="error-message" id="facadeWidthError">الرجاء إدخال عرض</div>
                            <span class="tooltip">أدخل عرض الواجهة</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">apartment</span> مواصفات البناء</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="floors">عدد الطوابق</label>
                            <input type="number" id="floors" class="form-control" required>
                            <div class="error-message" id="floorsError">الرجاء إدخال عدد</div>
                            <span class="tooltip">حدد عدد الطوابق</span>
                        </div>
                        <div class="form-group">
                            <label for="rooms">عدد الغرف</label>
                            <input type="number" id="rooms" class="form-control" required>
                            <div class="error-message" id="roomsError">الرجاء إدخال عدد</div>
                            <span class="tooltip">حدد عدد الغرف</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="groundFloorHeight">ارتفاع الطابق الأرضي (م)</label>
                            <input type="number" id="groundFloorHeight" class="form-control" required step="0.01">
                            <div class="error-message" id="groundFloorHeightError">الرجاء إدخال ارتفاع</div>
                            <span class="tooltip">أدخل ارتفاع الطابق الأرضي</span>
                        </div>
                        <div class="form-group">
                            <label for="otherFloorsHeight">ارتفاع باقي الطوابق (م)</label>
                            <input type="number" id="otherFloorsHeight" class="form-control" required step="0.01">
                            <div class="error-message" id="otherFloorsHeightError">الرجاء إدخال ارتفاع</div>
                            <span class="tooltip">أدخل ارتفاع باقي الطوابق</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bathrooms">عدد الحمامات</label>
                            <input type="number" id="bathrooms" class="form-control" required>
                            <div class="error-message" id="bathroomsError">الرجاء إدخال عدد</div>
                            <span class="tooltip">حدد عدد الحمامات</span>
                        </div>
                        <div class="form-group">
                            <label for="brickType">نوع الطابوق</label>
                            <select id="brickType" class="form-control" required>
                                <option value="yellow">أصفر</option><option value="red">أحمر</option><option value="other">أخرى</option>
                            </select>
                            <span class="tooltip">اختر نوع الطابوق</span>
                        </div>
                    </div>
                    <div id="otherBrickInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="brickWidth">عرض البلوكة (سم)</label>
                                <input type="number" id="brickWidth" class="form-control" step="0.01">
                                <span class="tooltip">أدخل عرض البلوكة</span>
                            </div>
                            <div class="form-group">
                                <label for="brickLength">طول البلوكة (سم)</label>
                                <input type="number" id="brickLength" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول البلوكة</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="brickHeight">ارتفاع البلوكة (سم)</label>
                                <input type="number" id="brickHeight" class="form-control" step="0.01">
                                <span class="tooltip">أدخل ارتفاع البلوكة</span>
                            </div>
                            <div class="form-group">
                                <label for="brickDensity">وزن البلوكة (كجم/م³)</label>
                                <input type="number" id="brickDensity" class="form-control" step="0.01">
                                <span class="tooltip">أدخل وزن البلوكة</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">attach_money</span> أسعار التشطيبات</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="flooringPrice">سعر م² تشطيب الأرضيات</label>
                            <input type="number" id="flooringPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="flooringPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر الأرضيات</span>
                        </div>
                        <div class="form-group">
                            <label for="wallInstallationPrice">سعر م² تركيب الجدران</label>
                            <input type="number" id="wallInstallationPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="wallInstallationPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر الجدران</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="wallPaintingPrice">سعر م² صبغ الجدران</label>
                            <input type="number" id="wallPaintingPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="wallPaintingPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر صبغ الجدران</span>
                        </div>
                        <div class="form-group">
                            <label for="windowsDoorsPrice">سعر م² شبابيك وأبواب</label>
                            <input type="number" id="windowsDoorsPrice" class="form-control" required step="0.01">
                            <div class="error-message" id="windowsDoorsPriceError">الرجاء إدخال سعر</div>
                            <span class="tooltip">أدخل سعر الشبابيك</span>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">build</span> خيارات إضافية</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="woodType">نوع الخشب</label>
                            <select id="woodType" class="form-control" required>
                                <option value="plywood">بلي وود</option>
                                <option value="regular">عادي</option>
                                <option value="waffle">Waffle Slab</option>
                            </select>
                            <span class="tooltip">اختر نوع الخشب</span>
                        </div>
                        <div class="form-group">
                            <label for="facadeType">نوع الواجهة</label>
                            <select id="facadeType" class="form-control" required>
                                <option value="economy">اقتصادية</option>
                                <option value="simple">تفاصيل بسيطة</option>
                                <option value="luxury">فخمة</option>
                                <option value="custom">مخصصة</option>
                            </select>
                            <span class="tooltip">اختر نوع الواجهة</span>
                        </div>
                    </div>
                    <div id="customFacadeInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="facadeArea">مساحة الواجهة المخصصة (م²)</label>
                                <input type="number" id="facadeArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الواجهة</span>
                            </div>
                            <div class="form-group">
                                <label for="facadePrice">سعر م² الواجهة</label>
                                <input type="number" id="facadePrice" class="form-control" step="0.01">
                                <span class="tooltip">أدخل سعر الواجهة</span>
                            </div>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleApartments">
                        <span><span class="material-icons-outlined">apartment</span> شقق سكنية</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="apartmentsInfo" class="toggle-content hidden">
                        <div class="form-group">
                            <label for="apartmentsCount">عدد الشقق</label>
                            <input type="number" id="apartmentsCount" class="form-control">
                            <span class="tooltip">حدد عدد الشقق</span>
                        </div>
                    </div>
                    <div class="toggle-section" id="toggleBasement">
                        <span><span class="material-icons-outlined">garage</span> طوابق سفلية</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="basementInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="basementFloors">عدد الطوابق السفلية</label>
                                <input type="number" id="basementFloors" class="form-control">
                                <span class="tooltip">حدد عدد الطوابق السفلية</span>
                            </div>
                            <div class="form-group">
                                <label for="basementCeilingArea">مساحة السقوف (م²)</label>
                                <input type="number" id="basementCeilingArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                            <div class="form-group">
                                <label for="basementPrice">سعر م² الطوابق السفلية</label>
                                <input type="number" id="basementPrice" class="form-control" step="0.01">
                                <span class="tooltip">أدخل سعر الطوابق السفلية</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <h3><span class="material-icons-outlined">home</span> المرافق</h3>
                    <div class="form-row">
                        <div class="checkbox-group"><input type="checkbox" id="hasGarden"><label for="hasGarden"><span class="material-icons-outlined">yard</span> حديقة</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasPool"><label for="hasPool"><span class="material-icons-outlined">pool</span> مسبح</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasHVAC"><label for="hasHVAC"><span class="material-icons-outlined">ac_unit</span> تدفئة وتبريد</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasElevator"><label for="hasElevator"><span class="material-icons-outlined">elevator</span> مصعد</label></div>
                        <div class="checkbox-group"><input type="checkbox" id="hasFence"><label for="hasFence"><span class="material-icons-outlined">fence</span> سياج</label></div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="toggle-section map-toggle" id="toggleMapDetails">
                        <span><span class="material-icons-outlined">map</span> تفاصيل الخريطة</span>
                        <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                    </div>
                    <div id="mapDetailsInfo" class="toggle-content hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="totalRoofArea">مساحة السقوف (م²)</label>
                                <input type="number" id="totalRoofArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                            <div class="form-group">
                                <label for="gardenArea">مساحة الحديقة (م²)</label>
                                <input type="number" id="gardenArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الحديقة</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="garagePathArea">مساحة الكراج والممرات (م²)</label>
                                <input type="number" id="garagePathArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الكراج</span>
                            </div>
                            <div class="form-group">
                                <label for="externalPlasterWalls">مساحة الجدران الخارجية (م²)</label>
                                <input type="number" id="externalPlasterWalls" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="skylightsArea">مساحة المناور (م²)</label>
                                <input type="number" id="skylightsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة المناور</span>
                            </div>
                            <div class="form-group">
                                <label for="tiesLength">طول الرباطات (م)</label>
                                <input type="number" id="tiesLength" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الرباطات</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invertedBeams">طول الجسور المقلوب (م)</label>
                                <input type="number" id="invertedBeams" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الجسور</span>
                            </div>
                            <div class="form-group">
                                <label for="externalWalls24cm">أطوال الجدران الخارجية 24سم (م)</label>
                                <input type="number" id="externalWalls24cm" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="internalWalls24cm">أطوال الجدران الداخلية 24سم (م)</label>
                                <input type="number" id="internalWalls24cm" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول الجدران</span>
                            </div>
                            <div class="form-group">
                                <label for="roofFenceLength">طول ستارة السطح (م)</label>
                                <input type="number" id="roofFenceLength" class="form-control" step="0.01">
                                <span class="tooltip">أدخل طول السياج</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="externalDoors">عدد الأبواب الخارجية</label>
                                <input type="number" id="externalDoors" class="form-control">
                                <span class="tooltip">حدد عدد الأبواب</span>
                            </div>
                            <div class="form-group">
                                <label for="internalDoors">عدد الأبواب الداخلية</label>
                                <input type="number" id="internalDoors" class="form-control">
                                <span class="tooltip">حدد عدد الأبواب</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="facadeWindowsDoorsArea">مساحة شبابيك وأبواب الواجهة (م²)</label>
                                <input type="number" id="facadeWindowsDoorsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الشبابيك</span>
                            </div>
                            <div class="form-group">
                                <label for="skylightWindowsDoorsArea">مساحة شبابيك المناور (م²)</label>
                                <input type="number" id="skylightWindowsDoorsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة المناور</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="secondaryCeilingsArea">مساحة السقوف الثانوية (م²)</label>
                                <input type="number" id="secondaryCeilingsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة السقوف</span>
                            </div>
                            <div class="form-group">
                                <label for="decorativeWallsArea">مساحة الجدران الديكورية (م²)</label>
                                <input type="number" id="decorativeWallsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="plasterWallsArea">مساحة لبخ الجدران (م²)</label>
                                <input type="number" id="plasterWallsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة لبخ الجدران</span>
                            </div>
                            <div class="form-group">
                                <label for="claddingWallsArea">مساحة الجدران التغليف (م²)</label>
                                <input type="number" id="claddingWallsArea" class="form-control" step="0.01">
                                <span class="tooltip">أدخل مساحة الجدران</span>
                            </div>
                        </div>
                        <div class="toggle-section" id="toggleStairsRailing">
                            <span><span class="material-icons-outlined">stairs</span> محجر الدرج</span>
                            <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                        </div>
                        <div id="stairsRailingInfo" class="toggle-content hidden">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="stairsRailingLength">طول محجر الدرج (م)</label>
                                    <input type="number" id="stairsRailingLength" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل طول محجر الدرج</span>
                                </div>
                                <div class="form-group">
                                    <label for="stairsRailingPrice">سعر المتر الطولي</label>
                                    <input type="number" id="stairsRailingPrice" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل سعر محجر الدرج</span>
                                </div>
                            </div>
                        </div>
                        <div class="toggle-section" id="toggleConcreteColumns">
                            <span><span class="material-icons-outlined">foundation</span> أعمدة كونكريت</span>
                            <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                        </div>
                        <div id="concreteColumnsInfo" class="toggle-content hidden">
                            <div class="form-group">
                                <label for="concreteVolume">حجم الكونكريت (م³)</label>
                                <input type="number" id="concreteVolume" class="form-control" step="0.01">
                                <span class="tooltip">أدخل حجم الكونكريت</span>
                            </div>
                        </div>
                        <div class="toggle-section" id="toggleInternalWalls">
                            <span><span class="material-icons-outlined">wallpaper</span> جدران داخلية</span>
                            <span class="toggle-icon"><span class="material-icons-outlined">add</span></span>
                        </div>
                        <div id="internalWallsInfo" class="toggle-content hidden">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="internalWallsArea">مساحة الجدران (م²)</label>
                                    <input type="number" id="internalWallsArea" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل مساحة الجدران</span>
                                </div>
                                <div class="form-group">
                                    <label for="internalWallsPrice">سعر م² الجدران</label>
                                    <input type="number" id="internalWallsPrice" class="form-control" step="0.01">
                                    <span class="tooltip">أدخل سعر الجدران</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block"><span class="material-icons-outlined">calculate</span> حساب التكلفة</button>
                    </div>
                    <div class="form-group">
                        <button type="reset" class="btn btn-reset btn-block"><span class="material-icons-outlined">delete</span> إعادة تعيين</button>
                    </div>
                </div>
            </form>
        </div>
        <div id="resultContainer" class="result-container">
            <div class="result-header">
                <h3><span class="material-icons-outlined">assessment</span> نتيجة الحساب</h3>
            </div>
            <div id="resultContent" class="result-content"></div>
            <button id="downloadPdf" class="btn btn-primary"><span class="material-icons-outlined">picture_as_pdf</span> تحميل PDF</button>
        </div>
    </div>
    <script>
        // تعريف أزرار التبديل ومحتواها
        const toggles = [
            { toggle: 'toggleApartments', content: 'apartmentsInfo' },
            { toggle: 'toggleBasement', content: 'basementInfo' },
            { toggle: 'toggleMapDetails', content: 'mapDetailsInfo' },
            { toggle: 'toggleStairsRailing', content: 'stairsRailingInfo' },
            { toggle: 'toggleConcreteColumns', content: 'concreteColumnsInfo' },
            { toggle: 'toggleInternalWalls', content: 'internalWallsInfo' }
        ];

        // إضافة أحداث التبديل لإظهار/إخفاء الأقسام
        toggles.forEach(({ toggle, content }) => {
            const toggleBtn = document.getElementById(toggle);
            const contentDiv = document.getElementById(content);
            if (toggleBtn && contentDiv) {
                toggleBtn.addEventListener('click', () => {
                    contentDiv.classList.toggle('hidden');
                    toggleBtn.querySelector('.toggle-icon span').textContent = contentDiv.classList.contains('hidden') ? 'add' : 'remove';
                });
            }
        });

        // إظهار/إخفاء الأقسام بناءً على اختيارات القوائم
        const toggleSelect = (selectId, contentId, triggerValue) => {
            const select = document.getElementById(selectId);
            const content = document.getElementById(contentId);
            if (select && content) {
                select.addEventListener('change', () => {
                    content.classList.toggle('hidden', select.value !== triggerValue);
                });
            }
        };
        toggleSelect('brickType', 'otherBrickInfo', 'other');
        toggleSelect('facadeType', 'customFacadeInfo', 'custom');

        // التحقق من صحة الحقول المطلوبة
        document.querySelectorAll('.form-control[required]').forEach(input => {
            input.addEventListener('input', () => {
                const errorDiv = document.getElementById(`${input.id}Error`);
                if (errorDiv) {
                    errorDiv.style.display = input.validity.valid ? 'none' : 'block';
                }
                input.style.borderColor = input.validity.valid ? '' : 'var(--danger)';
            });
        });

        // متغير عالمي لتخزين نتيجة الـ API
        let apiResult = null;

        // معالجة إرسال النموذج
        document.getElementById('buildingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="material-icons-outlined">hourglass_top</span> جارٍ الحساب...';
            submitBtn.disabled = true;

            // دالة لجمع القيم من الحقول
            const getValue = (id, isFloat = false, isInt = false) => {
                const element = document.getElementById(id);
                if (!element) return isInt ? 0 : isFloat ? 0 : '';
                let value = element.value.replace(/,/g, '');
                return isFloat ? parseFloat(value) || 0 : isInt ? parseInt(value) || 0 : value;
            };

            try {
                // جمع البيانات من النموذج
                const inputs = {
                    customer: {
                        name: getValue('customerName'),
                        phone: getValue('phoneNumber')
                    },
                    location: {
                        governorate: getValue('governorate'),
                        area: getValue('area')
                    },
                    land: {
                        area: getValue('landArea', true),
                        facadeWidth: getValue('facadeWidth', true)
                    },
                    building: {
                        floors: getValue('floors', false, true),
                        rooms: getValue('rooms', false, true),
                        bathrooms: getValue('bathrooms', false, true),
                        groundFloorHeight: getValue('groundFloorHeight', true),
                        otherFloorsHeight: getValue('otherFloorsHeight', true),
                        brickType: getValue('brickType'),
                        woodType: getValue('woodType'),
                        facadeType: getValue('facadeType'),
                        hasGarden: document.getElementById('hasGarden').checked,
                        hasPool: document.getElementById('hasPool').checked,
                        hasHVAC: document.getElementById('hasHVAC').checked,
                        hasElevator: document.getElementById('hasElevator').checked,
                        hasFence: document.getElementById('hasFence').checked
                    },
                    prices: {
                        flooring: getValue('flooringPrice', true),
                        wallInstallation: getValue('wallInstallationPrice', true),
                        wallPainting: getValue('wallPaintingPrice', true),
                        windowsDoors: getValue('windowsDoorsPrice', true)
                    },
                    hasMap: !document.getElementById('mapDetailsInfo').classList.contains('hidden'),
                    otherBrickInfo: !document.getElementById('otherBrickInfo').classList.contains('hidden'),
                    customFacadeInfo: !document.getElementById('customFacadeInfo').classList.contains('hidden'),
                    apartmentsInfo: !document.getElementById('apartmentsInfo').classList.contains('hidden'),
                    basementInfo: !document.getElementById('basementInfo').classList.contains('hidden'),
                    stairsRailingInfo: document.getElementById('mapDetailsInfo').classList.contains('hidden') ? false : !document.getElementById('stairsRailingInfo').classList.contains('hidden'),
                    concreteColumnsInfo: document.getElementById('mapDetailsInfo').classList.contains('hidden') ? false : !document.getElementById('concreteColumnsInfo').classList.contains('hidden'),
                    internalWallsInfo: document.getElementById('mapDetailsInfo').classList.contains('hidden') ? false : !document.getElementById('internalWallsInfo').classList.contains('hidden')
                };

                // جمع بيانات نوع الطابوق الأخرى
                if (inputs.otherBrickInfo) {
                    inputs.building.brickWidth = getValue('brickWidth', true);
                    inputs.building.brickLength = getValue('brickLength', true);
                    inputs.building.brickHeight = getValue('brickHeight', true);
                    inputs.building.brickDensity = getValue('brickDensity', true);
                }

                // جمع بيانات الواجهة المخصصة
                if (inputs.customFacadeInfo) {
                    inputs.building.facadeArea = getValue('facadeArea', true);
                    inputs.building.facadePrice = getValue('facadePrice', true);
                }

                // جمع بيانات الشقق
                if (inputs.apartmentsInfo) {
                    inputs.building.apartmentsCount = getValue('apartmentsCount', false, true);
                }

                // جمع بيانات الطوابق السفلية
                if (inputs.basementInfo) {
                    inputs.building.basementFloors = getValue('basementFloors', false, true);
                    inputs.building.basementCeilingArea = getValue('basementCeilingArea', true);
                    inputs.building.basementPrice = getValue('basementPrice', true);
                }

                // جمع بيانات محجر الدرج
                if (inputs.stairsRailingInfo && inputs.hasMap) {
                    inputs.stairsRailingLength = getValue('stairsRailingLength', true);
                    inputs.prices.stairsRailing = getValue('stairsRailingPrice', true);
                }

                // جمع بيانات تفاصيل الخريطة
                if (inputs.hasMap) {
                    inputs.technicalDetails = inputs.technicalDetails || {};
                    inputs.technicalDetails.totalRoofArea = getValue('totalRoofArea', true);
                    inputs.technicalDetails.gardenArea = getValue('gardenArea', true);
                    inputs.technicalDetails.garagePathArea = getValue('garagePathArea', true);
                    inputs.technicalDetails.externalPlasterWalls = getValue('externalPlasterWalls', true);
                    inputs.technicalDetails.skylightsArea = getValue('skylightsArea', true);
                    inputs.technicalDetails.tiesLength = getValue('tiesLength', true);
                    inputs.technicalDetails.invertedBeams = getValue('invertedBeams', true);
                    inputs.technicalDetails.externalWalls24cm = getValue('externalWalls24cm', true);
                    inputs.technicalDetails.internalWalls24cm = getValue('internalWalls24cm', true);
                    inputs.technicalDetails.roofFenceLength = getValue('roofFenceLength', true);
                    inputs.technicalDetails.externalDoors = getValue('externalDoors', false, true);
                    inputs.technicalDetails.internalDoors = getValue('internalDoors', false, true);
                    inputs.technicalDetails.facadeWindowsDoorsArea = getValue('facadeWindowsDoorsArea', true);
                    inputs.technicalDetails.skylightWindowsDoorsArea = getValue('skylightWindowsDoorsArea', true);
                    inputs.technicalDetails.secondaryCeilingsArea = getValue('secondaryCeilingsArea', true);
                    inputs.technicalDetails.decorativeWallsArea = getValue('decorativeWallsArea', true);
                    inputs.technicalDetails.claddingWallsArea = getValue('claddingWallsArea', true);
                    inputs.technicalDetails.plasterWallsArea = getValue('plasterWallsArea', true);
                }

                // جمع بيانات الجدران الداخلية
                if (inputs.internalWallsInfo && inputs.hasMap) {
                    inputs.technicalDetails = inputs.technicalDetails || {};
                    inputs.technicalDetails.internalWallsArea = getValue('internalWallsArea', true);
                    inputs.prices.internalWalls = getValue('internalWallsPrice', true);
                }

                // جمع بيانات أعمدة الكونكريت
                if (inputs.concreteColumnsInfo && inputs.hasMap) {
                    inputs.technicalDetails = inputs.technicalDetails || {};
                    inputs.technicalDetails.concreteVolume = getValue('concreteVolume', true);
                }

                // إرسال البيانات إلى الـ API
                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });

                if (!response.ok) {
                    throw new Error(`خطأ في الاتصال: ${response.status}`);
                }

                const result = await response.json();
                apiResult = result; // تخزين النتيجة لاستخدامها في generatePDF
                const resultContainer = document.getElementById('resultContainer');
                const contentDiv = document.getElementById('resultContent');

                // عرض النتائج
                contentDiv.innerHTML = `
                    <div class="result-section" id="pdfContent">
                        <h3>النتائج</h3>
                        <table>
                            <tr><th>البيان</th><th>القيمة</th></tr>
                            <tr><td>الرسالة</td><td>${result.result.message}</td></tr>
                            <tr><td>البيانات المدخلة</td><td><pre>${JSON.stringify(result.result.inputData, inputData, null, 2)}</pre></tr></td></tr>
                        </table>
                    </div>
                `;
                resultContainer.style.display = 'block';

                // دالة إنشاء PDF
                document.getElementById('downloadPdf').addEventListener('click', () => {
                    if (!apiResult) {
                        alert('يرجى حساب التكلفة أولاً');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'letter' });

                    // إعداد خط Amiri
                    doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
                    doc.setFont('Amiri');

                    // الصفحة الأولى: الغلاف
                    doc.setFontSize(92, 64, 0.51);
                    doc.text('تقرير تكاليف البناء', 4.15, 0.8, { align: 'center' });
                    doc.setFontSize(16);
                    doc.text('شركة البناء المثالية', 4.15, 1.6, { align: 'center' });
                    doc.text(`العميل: ${apiResult.result.inputData.customer.name || 'غير محدد'}`, 4.15, 2.4, { align: 'center' });
                    doc.text(`العنوان: ${apiResult.result.inputData.location.governorate || 'غير محدد'}`, 4.15, 3.2, { align: 'center' });
                    doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-IQ')}`, 4.15, 4.0, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('تقرير مفصل لمشروعك السكني يوضح التكاليف والتحليل الإنشائي', 4.15, 4.8, { align: 'center' });

                    // الصفحة الثانية: مدخلات العميل
                    doc.addPage();
                    doc.setFontSize(18);
                    doc.text('بيانات المشروع', 4.15, 0.8, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('هذه هي المعلومات التي قدمتها لنا لبناء التقرير:', 0.8, 1.6, { align: 'right' });

                    const clientInputs = [
                        ['اسم العميل', apiResult.result.inputData.customer.name || 'غير محدد'],
                        ['رقم الهاتف', apiResult.result.inputData.customer.phone || 'غير محدد'],
                        ['المحافظة', apiResult.result.inputData.location.governorate || 'غير محدد'],
                        ['المنطقة/الحي', apiResult.result.inputData.location.area || 'غير محدد'],
                        ['مساحة الأرض (م²)', apiResult.result.inputData.land.area || 'غير محدد'],
                        ['عرض الواجهة (م)', apiResult.result.inputData.land.facadeWidth || 'غير محدد'],
                        ['عدد الطوابق', apiResult.result.inputData.building.floors || 'غير محدد'],
                        ['عدد الغرف', apiResult.result.inputData.building.rooms || 'غير محدد'],
                        ['عدد الحمامات', apiResult.result.inputData.building.bathrooms || 'غير محدد'],
                        ['ارتفاع الطابق الأرضي (م)', apiResult.result.inputData.building.groundFloorHeight || 'غير محدد'],
                        ['ارتفاع باقي الطوابق (م)', apiResult.result.inputData.building.otherFloorsHeight || 'غير محدد'],
                        ['نوع الطابوق', apiResult.result.inputData.building.brickType === 'yellow' ? 'أصفر' : apiResult.result.inputData.building.brickType === 'red' ? 'أحمر' : 'مخصص'],
                        ['نوع الخشب', apiResult.result.inputData.building.woodType || 'غير محدد'],
                        ['نوع الواجهة', apiResult.result.inputData.building.facadeType || 'غير محدد'],
                        ['حديقة', apiResult.result.inputData.building.hasGarden ? 'نعم' : 'لا'],
                        ['مسبح', apiResult.result.inputData.building.hasPool ? 'نعم' : 'لا'],
                        ['تكييف مركزي', apiResult.result.inputData.building.hasHVAC ? 'نعم' : 'لا'],
                        ['مصعد', apiResult.result.inputData.building.hasElevator ? 'نعم' : 'لا'],
                        ['سياج', apiResult.result.inputData.building.hasFence ? 'نعم' : 'لا'],
                    ];

                    if (apiResult.result.inputData.building.brickType === 'other') {
                        clientInputs.push(['عرض البلوكة (سم)', apiResult.result.inputData.building.brickWidth || 'غير محدد']);
                        clientInputs.push(['طول البلوكة (سم)', apiResult.result.inputData.building.brickLength || 'غير محدد']);
                        clientInputs.push(['ارتفاع البلوكة (سم)', apiResult.result.inputData.building.brickHeight || 'غير محدد']);
                        clientInputs.push(['كثافة البلوكة (كجم/م³)', apiResult.result.inputData.building.brickDensity || 'غير محدد']);
                    }

                    if (apiResult.result.inputData.building.facadeType === 'custom') {
                        clientInputs.push(['مساحة الواجهة المخصصة (م²)', apiResult.result.inputData.building.facadeArea || 'غير محدد']);
                        clientInputs.push(['سعر م² الواجهة', apiResult.result.inputData.building.facadePrice || 'غير محدد']);
                    }

                    if (apiResult.result.inputData.building.apartmentsCount) {
                        clientInputs.push(['عدد الشقق', apiResult.result.inputData.building.apartmentsCount || 'غير محدد']);
                    }

                    if (apiResult.result.inputData.building.basementFloors) {
                        clientInputs.push(['عدد الطوابق السفلية', apiResult.result.inputData.building.basementFloors || 'غير محدد']);
                        clientInputs.push(['مساحة السقوف السفلية (م²)', apiResult.result.inputData.building.basementCeilingArea || 'غير محدد']);
                        clientInputs.push(['سعر م² الطوابق السفلية', apiResult.result.inputData.building.basementPrice || 'غير محدد']);
                    }

                    if (apiResult.result.inputData.technicalDetails) {
                        clientInputs.push(['مساحة السقوف (م²)', apiResult.result.inputData.technicalDetails.totalRoofArea || 'غير محدد']);
                        clientInputs.push(['مساحة الحديقة (م²)', apiResult.result.inputData.technicalDetails.gardenArea || 'غير محدد']);
                        clientInputs.push(['مساحة الكراج والممرات (م²)', apiResult.result.inputData.technicalDetails.garagePathArea || 'غير محدد']);
                        clientInputs.push(['مساحة الجدران الخارجية (م²)', apiResult.result.inputData.technicalDetails.externalPlasterWalls || 'غير محدد']);
                        clientInputs.push(['مساحة المناور (م²)', apiResult.result.inputData.technicalDetails.skylightsArea || 'غير محدد']);
                        clientInputs.push(['طول الرباطات (م)', apiResult.result.inputData.technicalDetails.tiesLength || 'غير محدد']);
                        clientInputs.push(['طول الجسور المقلوبة (م)', apiResult.result.inputData.technicalDetails.invertedBeams || 'غير محدد']);
                        clientInputs.push(['أطوال الجدران الخارجية 24سم (م)', apiResult.result.inputData.technicalDetails.externalWalls24cm || 'غير محدد']);
                        clientInputs.push(['أطوال الجدران الداخلية 24سم (م)', apiResult.result.inputData.technicalDetails.internalWalls24cm || 'غير محدد']);
                        clientInputs.push(['طول ستارة السطح (م)', apiResult.result.inputData.technicalDetails.roofFenceLength || 'غير محدد']);
                        clientInputs.push(['عدد الأبواب الخارجية', apiResult.result.inputData.technicalDetails.externalDoors || 'غير محدد']);
                        clientInputs.push(['عدد الأبواب الداخلية', apiResult.result.inputData.technicalDetails.internalDoors || 'غير محدد']);
                        clientInputs.push(['مساحة شبابيك وأبواب الواجهة (م²)', apiResult.result.inputData.technicalDetails.facadeWindowsDoorsArea || 'غير محدد']);
                        clientInputs.push(['مساحة شبابيك المناور (م²)', apiResult.result.inputData.technicalDetails.skylightWindowsDoorsArea || 'غير محدد']);
                        clientInputs.push(['مساحة السقوف الثانوية (م²)', apiResult.result.inputData.technicalDetails.secondaryCeilingsArea || 'غير محدد']);
                        clientInputs.push(['مساحة الجدران الديكورية (م²)', apiResult.result.inputData.technicalDetails.decorativeWallsArea || 'غير محدد']);
                        clientInputs.push(['مساحة لبخ الجدران (م²)', apiResult.result.inputData.technicalDetails.plasterWallsArea || 'غير محدد']);
                        clientInputs.push(['مساحة الجدران التغليف (م²)', apiResult.result.inputData.technicalDetails.claddingWallsArea || 'غير محدد']);
                        if (apiResult.result.inputData.technicalDetails.concreteVolume) {
                            clientInputs.push(['حجم الكونكريت (م³)', apiResult.result.inputData.technicalDetails.concreteVolume || 'غير محدد']);
                        }
                        if (apiResult.result.inputData.technicalDetails.internalWallsArea) {
                            clientInputs.push(['مساحة الجدران الداخلية (م²)', apiResult.result.inputData.technicalDetails.internalWallsArea || 'غير محدد']);
                        }
                    }

                    doc.autoTable({
                        head: [['البند', 'القيمة']],
                        body: clientInputs,
                        startY: 2.0,
                        styles: { font: 'Amiri', halign: 'right', fontSize: 10 },
                        headStyles: { fillColor: [92, 64, 51] }, // لون يتماشى مع --primary
                        columnStyles: { 0: { cellWidth: 2.5 }, 1: { cellWidth: 5.0 } },
                    });

                    // الصفحة الثالثة: تفاصيل التكاليف
                    doc.addPage();
                    doc.setFontSize(18);
                    doc.text('تفاصيل التكاليف', 4.15, 0.8, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('هذا الجدول يوضح تكلفة كل جزء من مشروعك (بالدينار العراقي):', 0.8, 1.6, { align: 'right' });

                    const costTranslations = {
                        structural: 'التحليل الإنشائي',
                        excavation: 'الحفر والفرش',
                        facade: 'الواجهة',
                        raft: 'الرفت',
                        flooring: 'الأرضيات',
                        concrete: 'الكونكريت',
                        steel: 'الحديد',
                        plastering: 'البياض',
                        bricks: 'الطابوق',
                        skylights: 'المناور',
                        flooringMortar: 'مونة الأرضيات',
                        wallsMortar: 'مونة الجدران',
                        plasterMortar: 'مونة اللبخ',
                        materialTransport: 'نقل المواد',
                        electricalMaterials: 'المواد الكهربائية',
                        electricalLabor: 'أجور الكهربائي',
                        plumbingMaterials: 'مواد الصحيات',
                        plumbingLabor: 'أجور الصحيات',
                        brickLabor: 'أجور الطابوق',
                        carpentryAndSteelLabor: 'أجور النجارة والحدادة',
                        facadeLabor: 'أجور الواجهة',
                        externalDoor: 'الباب الخارجي',
                        skylightCost: 'تكلفة المناور',
                        cladding: 'تطبيق الجدران',
                        painting: 'الصبغ',
                        plasteringCost: 'لبخ الجدران',
                        bathroomFurnishing: 'تأثيث الحمامات',
                        garageCover: 'مسقف الكراج',
                        electricalBoard: 'بورد الكهرباء',
                        hvac: 'دكتات الهواء',
                    };

                    const costTable = Object.entries(apiResult.result.costBreakdown || {}).map(([key, value]) => [
                        costTranslations[key] || key,
                        value.toLocaleString('ar-IQ'),
                    ]);

                    doc.autoTable({
                        head: [['البند', 'التكلفة (د.ع)']],
                        body: costTable,
                        startY: 2.0,
                        styles: { font: 'Amiri', halign: 'right', fontSize: 10 },
                        headStyles: { fillColor: [92, 64, 51] },
                        columnStyles: { 0: { cellWidth: 4.0 }, 1: { cellWidth: 3.5 } },
                    });

                    doc.setFontSize(14);
                    doc.text(`الإجمالي: ${(apiResult.result.totalCost || 0).toLocaleString('ar-IQ')} د.ع`, 0.8, doc.lastAutoTable.finalY + 0.4, { align: 'right' });

                    // الصفحة الرابعة: التحليل الإنشائي
                    doc.addPage();
                    doc.setFontSize(18);
                    doc.text('التحليل الإنشائي', 4.15, 0.8, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('نقوم بحسابات دقيقة لضمان أن منزلك آمن وقوي. إليك شرحًا بسيطًا:', 0.8, 1.6, { align: 'right' });

                    doc.text('1. حساب الوزن الكلي للمبنى:', 0.8, 2.4, { align: 'right' });
                    doc.text('الوزن الكلي = (وزن الطابوق + وزن الكونكريت) × 9.81 + الأحمال الحية', 0.8, 2.8, { align: 'right' });
                    doc.text(`الوزن الكلي: ${(apiResult.result.details.totalWeight || 0).toFixed(2)} كيلو نيوتن`, 0.8, 3.2, { align: 'right' });
                    doc.text('هذا الوزن يخبرنا كم يضغط المبنى على الأرض.', 0.8, 3.6, { align: 'right' });

                    doc.text('2. حساب الضغط على الأرض:', 0.8, 4.4, { align: 'right' });
                    doc.text('الضغط = الوزن الكلي ÷ مساحة الأرض', 0.8, 4.8, { align: 'right' });
                    doc.text(`نتيجة الضغط: ${(apiResult.result.details.pressure || 0).toFixed(2)} كيلو نيوتن/م²`, 0.8, 5.2, { align: 'right' });
                    doc.text('الضغط يحدد نوع الأساس (الرفت) الذي نحتاجه.', 0.8, 5.6, { align: 'right' });

                    doc.text('3. نوع الأساس (الرفت):', 0.8, 6.4, { align: 'right' });
                    doc.text(`نوع الرفت: ${apiResult.result.details.raftType === 'regular' ? 'عادي' : apiResult.result.details.raftType === 'reinforced' ? 'مقوى' : 'خاص'}`, 0.8, 6.8, { align: 'right' });
                    doc.text(`سمك الرفت: ${(apiResult.result.details.raftThickness || 0).toFixed(2)} متر`, 0.8, 7.2, { align: 'right' });
                    doc.text('الرفت هو الأساس الذي يحمل منزلك ويوزع الوزن على الأرض.', 0.8, 7.6, { align: 'right' });

                    doc.text('4. التحقق من الجدران:', 0.8, 8.4, { align: 'right' });
                    doc.text(`حالة الجدران: ${apiResult.result.details.wallCheck || 'مستقرة'}`, 0.8, 8.8, { align: 'right' });
                    doc.text('نتأكد أن جدران الطابق الأرضي قوية بما يكفي لتحمل الوزن.', 0.8, 9.2, { align: 'right' });

                    // الصفحة الخامسة: الكميات
                    doc.addPage();
                    doc.setFontSize(18);
                    doc.text('الكميات المطلوبة', 4.15, 0.8, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('هذا الجدول يوضح الكميات المطلوبة لمشروعك:', 0.8, 1.6, { align: 'right' });

                    const quantitiesTable = [
                        ['حجم الكونكريت (م³)', (apiResult.result.details.concreteVolume || 0).toFixed(2)],
                        ['كمية الحديد (كجم)', (apiResult.result.details.steelQuantity || 0).toFixed(2)],
                        ['عدد الطابوق (طابوقة)', Math.ceil(apiResult.result.details.brickCount || 0)],
                        ['مساحة الواجهة (م²)', (apiResult.result.details.facadeArea || 0).toFixed(2)],
                        ['مساحة الأرضيات (م²)', (apiResult.result.details.flooringArea || 0).toFixed(2)],
                        ['مساحة البياض (م²)', (apiResult.result.details.plasteringArea || 0).toFixed(2)],
                    ];

                    doc.autoTable({
                        head: [['البند', 'الكمية']],
                        body: quantitiesTable,
                        startY: 2.0,
                        styles: { font: 'Amiri', halign: 'right', fontSize: 10 },
                        headStyles: { fillColor: [92, 64, 51] },
                        columnStyles: { 0: { cellWidth: 4.0 }, 1: { cellWidth: 3.5 } },
                    });

                    // حفظ ملف PDF
                    doc.save(`تقرير_تكاليف_البناء_${apiResult.result.inputData.customer.name || 'مشروع'}.pdf`);
                });
            } catch (error) {
                // عرض الأخطاء إذا حدثت
                document.getElementById('resultContent').innerHTML = `<p style="color: #C75656;">خطأ: ${error.message}</p>`;
                document.getElementById('resultContainer').style.display = 'block';
            } finally {
                // إعادة تعيين زر الإرسال
                submitBtn.innerHTML = '<span class="material-icons-outlined">calculate</span> حساب التكلفة';
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
