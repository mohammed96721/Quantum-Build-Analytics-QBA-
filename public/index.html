<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام حساب تكاليف البناء - العراق</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        :root {
            --primary: #5C4033; --accent: #E8B923; --background: #F5F1E9; --secondary-bg: #EDE7E0;
            --highlight: #A8C4A2; --text: #2A2A2A; --danger: #C75656; --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            --border: #E4E2DB; --transparent-bg: rgba(255, 245, 235, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; }
        body { background: linear-gradient(135deg, #FFF6E6, #F5F1E9); color: var(--text); line-height: 1.5; overflow-x: hidden; }
        .container { max-width: 700px; margin: 15px auto; padding: 8px; }
        .language-selector select {
            padding: 4px 6px; font-size: 0.75rem; border-radius: 5px; border: 1px solid var(--border);
            background: var(--transparent-bg); cursor: pointer; transition: all 0.2s; max-width: 120px;
        }
        .language-selector select:focus { border-color: var(--accent); box-shadow: 0 0 3px rgba(232, 185, 35, 0.5); }
        .disclaimer {
            background: var(--transparent-bg); border-right: 3px solid var(--accent); padding: 8px; margin-bottom: 10px;
            border-radius: 5px; box-shadow: var(--shadow); backdrop-filter: blur(6px); animation: fadeIn 0.3s;
        }
        .disclaimer h2 { color: var(--danger); font-size: 0.85rem; margin-bottom: 3px; display: flex; align-items: center; gap: 4px; }
        .disclaimer p { font-size: 0.65rem; }
        .form-card { background: var(--secondary-bg); border-radius: 6px; box-shadow: var(--shadow); padding: 10px; margin-bottom: 12px; }
        .form-header { text-align: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
        .form-header h2 { color: var(--primary); font-size: 1.1rem; display: flex; justify-content: center; align-items: center; gap: 4px; }
        .form-header p { font-size: 0.6rem; }
        .form-section {
            margin-bottom: 8px; padding: 8px; background: var(--transparent-bg); border-radius: 5px;
            border-left: 3px solid var(--primary); transition: transform 0.2s, box-shadow 0.2s;
        }
        .form-section:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); }
        .form-section h3 { color: var(--primary); font-size: 0.95rem; margin-bottom: 5px; display: flex; align-items: center; gap: 4px; }
        .form-group { margin-bottom: 6px; position: relative; }
        .form-group label { display: block; margin-bottom: 2px; font-weight: 500; font-size: 0.7rem; }
        .form-control {
            width: 100%; max-width: 200px; padding: 4px 6px; border: 1px solid var(--border); border-radius: 5px;
            font-size: 0.75rem; background: var(--transparent-bg); transition: all 0.2s; height: 26px;
            text-align: left;
        }
        .form-control:focus { border-color: var(--accent); box-shadow: 0 0 6px rgba(232, 185, 35, 0.3); transform: scale(1.01); outline: none; }
        .form-control:invalid:focus { border-color: var(--danger); box-shadow: 0 0 6px rgba(199, 86, 86, 0.3); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 6px; }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 4px; font-weight: 500;
            padding: 6px 12px; font-size: 0.75rem; border-radius: 5px; border: none; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #D4A017); color: var(--text); }
        .btn-primary:hover { background: linear-gradient(135deg, #D4A017, var(--accent)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(232, 185, 35, 0.4); }
        .btn-reset { background: linear-gradient(135deg, var(--danger), #A13636); color: #FFFFFF; }
        .btn-reset:hover { background: linear-gradient(135deg, #A13636, var(--danger)); transform: translateY(-1px); box-shadow: 0 4px 10px rgba(199, 86, 86, 0.4); }
        .btn-block { width: 100%; max-width: 200px; }
        .hidden { display: none; }
        .toggle-section {
            background: var(--transparent-bg); padding: 6px; border-radius: 5px; margin-bottom: 5px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); transition: all 0.2s;
        }
        .toggle-section:hover { background: rgba(255, 245, 235, 0.98); transform: translateY(-1px); }
        .map-toggle { background: linear-gradient(135deg, var(--highlight), #8BAF7F); padding: 10px; font-size: 0.95rem; font-weight: 600; border-radius: 6px; box-shadow: 0 3px 10px rgba(168, 196, 162, 0.3); color: #FFFFFF; }
        .map-toggle:hover { background: linear-gradient(135deg, #8BAF7F, var(--highlight)); transform: translateY(-2px); }
        .toggle-content { padding: 6px; background: var(--transparent-bg); border-radius: 5px; margin-top: 4px; border: 1px solid var(--border); animation: fadeIn 0.3s; }
        .checkbox-group { display: flex; align-items: center; gap: 4px; margin-bottom: 5px; }
        .checkbox-group input { width: 12px; height: 12px; accent-color: var(--primary); }
        .result-container { margin-top: 10px; padding: 10px; background: linear-gradient(135deg, var(--primary), #7A5A45); border-radius: 6px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); color: #FFFFFF; display: none; animation: slideIn 0.3s; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding-bottom: 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-header h3 { font-size: 1rem; display: flex; align-items: center; gap: 4px; }
        .result-content table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        .result-content th, .result-content td { padding: 6px; text-align: right; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .result-content th { background: rgba(255, 255, 255, 0.1); color: #FFFFFF; }
        .error-message { color: var(--danger); font-size: 0.6rem; margin-top: 2px; display: none; animation: fadeIn 0.2s; }
        .tooltip { position: absolute; background: var(--primary); color: #FFFFFF; padding: 2px 5px; border-radius: 4px; font-size: 0.6rem; top: -22px; right: 5px; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .form-group:hover .tooltip { opacity: 1; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(6px); } to { opacity: 1; transform: translateX(0); } }
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .form-control, .btn-block { max-width: 100%; }
            .container { padding: 5px; }
            .form-card { padding: 8px; }
            .form-section { padding: 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="language-selector">
            <select id="languageSelect" class="form-control">
                <option value="ar">العربية</option>
            </select>
        </div>

        <form id="buildingForm">
            <!-- بيانات العميل -->
            <div class="form-section">
                <h2>بيانات العميل</h2>
                <div class="mb-3">
                    <label for="customerName" class="form-label">اسم العميل</label>
                    <input type="text" class="form-control" id="customerName" required>
                </div>
                <div class="mb-3">
                    <label for="customerPhone" class="form-label">رقم الهاتف</label>
                    <input type="tel" class="form-control" id="customerPhone">
                </div>
            </div>

            <!-- معلومات الموقع -->
            <div class="form-section">
                <h2>معلومات الموقع</h2>
                <div class="mb-3">
                    <label for="governorate" class="form-label">المحافظة</label>
                    <input type="text" class="form-control" id="governorate" required>
                </div>
                <div class="mb-3">
                    <label for="area" class="form-label">المنطقة</label>
                    <input type="text" class="form-control" id="area">
                </div>
            </div>

            <!-- معلومات الأرض -->
            <div class="form-section">
                <h2>معلومات الأرض</h2>
                <div class="mb-3">
                    <label for="landArea" class="form-label">مساحة الأرض (م²)</label>
                    <input type="number" step="0.01" class="form-control" id="landArea" required>
                </div>
                <div class="mb-3">
                    <label for="facadeWidth" class="form-label">عرض الواجهة (م)</label>
                    <input type="number" step="0.01" class="form-control" id="facadeWidth" required>
                </div>
            </div>

            <!-- تفاصيل المبنى -->
            <div class="form-section">
                <h2>تفاصيل المبنى</h2>
                <div class="mb-3">
                    <label for="floors" class="form-label">عدد الطوابق</label>
                    <input type="number" class="form-control" id="floors" required>
                </div>
                <div class="mb-3">
                    <label for="rooms" class="form-label">عدد الغرف</label>
                    <input type="number" class="form-control" id="rooms" required>
                </div>
                <div class="mb-3">
                    <label for="bathrooms" class="form-label">عدد الحمامات</label>
                    <input type="number" class="form-control" id="bathrooms" required>
                </div>
                <div class="mb-3">
                    <label for="groundFloorHeight" class="form-label">ارتفاع الطابق الأرضي (م)</label>
                    <input type="number" step="0.01" class="form-control" id="groundFloorHeight" required>
                </div>
                <div class="mb-3">
                    <label for="otherFloorsHeight" class="form-label">ارتفاع الطوابق الأخرى (م)</label>
                    <input type="number" step="0.01" class="form-control" id="otherFloorsHeight" required>
                </div>
                <div class="mb-3">
                    <label for="ceilingThickness" class="form-label">سمك السقف (م)</label>
                    <input type="number" step="0.01" class="form-control" id="ceilingThickness" required>
                </div>
                <div class="mb-3">
                    <label for="brickType" class="form-label">نوع الطابوق</label>
                    <select class="form-select" id="brickType" required>
                        <option value="yellow">طابوق أصفر</option>
                        <option value="red">طابوق أحمر</option>
                        <option value="thermostone">ثرمستون</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="ceilingDetails" class="form-label">تفاصيل السقف</label>
                    <select class="form-select" id="ceilingDetails" required>
                        <option value="regular">عادي</option>
                        <option value="plywood">بليوود</option>
                        <option value="waffle">وافل</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="facadeType" class="form-label">نوع الواجهة</label>
                    <select class="form-select" id="facadeType" required>
                        <option value="economy">اقتصادية</option>
                        <option value="simple">بسيطة</option>
                        <option value="luxury">فاخرة</option>
                    </select>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="hasGarden">
                    <label class="form-check-label" for="hasGarden">وجود حديقة</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="hasPool">
                    <label class="form-check-label" for="hasPool">وجود مسبح</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="hasHVAC">
                    <label class="form-check-label" for="hasHVAC">وجود تكييف</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="hasElevator">
                    <label class="form-check-label" for="hasElevator">وجود مصعد</label>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="hasFence">
                    <label class="form-check-label" for="hasFence">وجود سياج</label>
                </div>
            </div>

            <!-- التفاصيل الفنية (إذا كان هناك خريطة) -->
            <div class="form-section">
                <h2>التفاصيل الفنية (اختياري)</h2>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="hasMap">
                    <label class="form-check-label" for="hasMap">هل لديك خريطة؟</label>
                </div>
                <div id="technicalDetails" style="display: none;">
                    <div class="mb-3">
                        <label for="totalRoofArea" class="form-label">مساحة السقوف (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="totalRoofArea">
                    </div>
                    <div class="mb-3">
                        <label for="gardenArea" class="form-label">مساحة الحديقة (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="gardenArea">
                    </div>
                    <div class="mb-3">
                        <label for="garagePathArea" class="form-label">مساحة الكراج (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="garagePathArea">
                    </div>
                    <div class="mb-3">
                        <label for="skylightsArea" class="form-label">مساحة المناور (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="skylightsArea">
                    </div>
                    <div class="mb-3">
                        <label for="tiesLength" class="form-label">طول الرباطات (م)</label>
                        <input type="number" step="0.01" class="form-control" id="tiesLength">
                    </div>
                    <div class="mb-3">
                        <label for="invertedBeams" class="form-label">طول الجسور المقلوبة (م)</label>
                        <input type="number" step="0.01" class="form-control" id="invertedBeams">
                    </div>
                    <div class="mb-3">
                        <label for="externalWalls24cm" class="form-label">جدران خارجية 24سم (م)</label>
                        <input type="number" step="0.01" class="form-control" id="externalWalls24cm">
                    </div>
                    <div class="mb-3">
                        <label for="internalWalls24cm" class="form-label">جدران داخلية 24سم (م)</label>
                        <input type="number" step="0.01" class="form-control" id="internalWalls24cm">
                    </div>
                    <div class="mb-3">
                        <label for="roofFenceLength" class="form-label">ستارة السطح (م)</label>
                        <input type="number" step="0.01" class="form-control" id="roofFenceLength">
                    </div>
                    <div class="mb-3">
                        <label for="externalDoors" class="form-label">عدد الأبواب الخارجية</label>
                        <input type="number" class="form-control" id="externalDoors">
                    </div>
                    <div class="mb-3">
                        <label for="internalDoors" class="form-label">عدد الأبواب الداخلية</label>
                        <input type="number" class="form-control" id="internalDoors">
                    </div>
                    <div class="mb-3">
                        <label for="facadeWindowsDoorsArea" class="form-label">شبابيك الواجهة (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="facadeWindowsDoorsArea">
                    </div>
                    <div class="mb-3">
                        <label for="skylightWindowsDoorsArea" class="form-label">شبابيك المناور (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="skylightWindowsDoorsArea">
                    </div>
                    <div class="mb-3">
                        <label for="secondaryCeilingsArea" class="form-label">سقوف ثانوية (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="secondaryCeilingsArea">
                    </div>
                    <div class="mb-3">
                        <label for="decorativeWallsArea" class="form-label">جدران ديكورية (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="decorativeWallsArea">
                    </div>
                    <div class="mb-3">
                        <label for="claddingWallsArea" class="form-label">جدران التغليف (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="claddingWallsArea">
                    </div>
                    <div class="mb-3">
                        <label for="plasterWallsArea" class="form-label">جص خارجي (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="plasterWallsArea">
                    </div>
                </div>
            </div>

            <!-- الأقسام المشروطة -->
            <div class="form-section">
                <h2>الأقسام المشروطة</h2>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="customFacadeInfo">
                    <label class="form-check-label" for="customFacadeInfo">واجهة مخصصة</label>
                </div>
                <div id="customFacadeFields" style="display: none;">
                    <div class="mb-3">
                        <label for="facadeArea" class="form-label">مساحة الواجهة (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="facadeArea">
                    </div>
                    <div class="mb-3">
                        <label for="facadePrice" class="form-label">سعر الواجهة (د.ع/م²)</label>
                        <input type="number" step="0.01" class="form-control" id="facadePrice">
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="waffleSlabInfo">
                    <label class="form-check-label" for="waffleSlabInfo">معلومات سقف وافل</label>
                </div>
                <div id="waffleSlabFields" style="display: none;">
                    <div class="mb-3">
                        <label for="voidSize" class="form-label">حجم الفراغ (م³)</label>
                        <input type="number" step="0.01" class="form-control" id="voidSize">
                    </div>
                    <div class="mb-3">
                        <label for="voidCount" class="form-label">عدد الفراغات</label>
                        <input type="number" class="form-control" id="voidCount">
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="apartmentsInfo">
                    <label class="form-check-label" for="apartmentsInfo">معلومات الشقق</label>
                </div>
                <div id="apartmentsFields" style="display: none;">
                    <div class="mb-3">
                        <label for="apartmentsCount" class="form-label">عدد الشقق</label>
                        <input type="number" class="form-control" id="apartmentsCount">
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="basementInfo">
                    <label class="form-check-label" for="basementInfo">معلومات الطوابق السفلية</label>
                </div>
                <div id="basementFields" style="display: none;">
                    <div class="mb-3">
                        <label for="basementFloors" class="form-label">عدد الطوابق السفلية</label>
                        <input type="number" class="form-control" id="basementFloors">
                    </div>
                    <div class="mb-3">
                        <label for="basementCeilingArea" class="form-label">مساحة السقوف السفلية (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="basementCeilingArea">
                    </div>
                    <div class="mb-3">
                        <label for="basementPrice" class="form-label">سعر م² الطوابق السفلية (د.ع)</label>
                        <input type="number" step="0.01" class="form-control" id="basementPrice">
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="stairsRailingInfo">
                    <label class="form-check-label" for="stairsRailingInfo">معلومات محجر الدرج</label>
                </div>
                <div id="stairsRailingFields" style="display: none;">
                    <div class="mb-3">
                        <label for="stairsRailingLength" class="form-label">طول محجر الدرج (م)</label>
                        <input type="number" step="0.01" class="form-control" id="stairsRailingLength">
                    </div>
                    <div class="mb-3">
                        <label for="stairsRailingPrice" class="form-label">سعر محجر الدرج (د.ع/م)</label>
                        <input type="number" step="0.01" class="form-control" id="stairsRailingPrice">
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="internalWallsInfo">
                    <label class="form-check-label" for="internalWallsInfo">معلومات الجدران الداخلية</label>
                </div>
                <div id="internalWallsFields" style="display: none;">
                    <div class="mb-3">
                        <label for="internalWallsArea" class="form-label">مساحة الجدران الداخلية (م²)</label>
                        <input type="number" step="0.01" class="form-control" id="internalWallsArea">
                    </div>
                    <div class="mb-3">
                        <label for="internalWallsPrice" class="form-label">سعر الجدران الداخلية (د.ع/م²)</label>
                        <input type="number" step="0.01" class="form-control" id="internalWallsPrice">
                    </div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="concreteColumnsInfo">
                    <label class="form-check-label" for="concreteColumnsInfo">معلومات الأعمدة الخرسانية</label>
                </div>
                <div id="concreteColumnsFields" style="display: none;">
                    <div class="mb-3">
                        <label for="concreteVolume" class="form-label">حجم الكونكريت (م³)</label>
                        <input type="number" step="0.01" class="form-control" id="concreteVolume">
                    </div>
                </div>
            </div>

            <!-- أسعار التشطيب -->
            <div class="form-section">
                <h2>أسعار التشطيب (اختياري)</h2>
                <div class="mb-3">
                    <label for="flooringPrice" class="form-label">تشطيب الأرضيات (د.ع/م²)</label>
                    <input type="number" step="0.01" class="form-control" id="flooringPrice">
                </div>
                <div class="mb-3">
                    <label for="wallInstallationPrice" class="form-label">تركيب الجدران (د.ع/م²)</label>
                    <input type="number" step="0.01" class="form-control" id="wallInstallationPrice">
                </div>
                <div class="mb-3">
                    <label for="wallPaintingPrice" class="form-label">صبغ الجدران (د.ع/م²)</label>
                    <input type="number" step="0.01" class="form-control" id="wallPaintingPrice">
                </div>
                <div class="mb-3">
                    <label for="windowsDoorsPrice" class="form-label">شبابيك وأبواب (د.ع/م²)</label>
                    <input type="number" step="0.01" class="form-control" id="windowsDoorsPrice">
                </div>
            </div>

            <!-- زر الإرسال -->
            <button type="submit" class="btn btn-primary">
                <span class="material-icons-outlined">calculate</span> حساب التكلفة
            </button>
        </form>

        <!-- قسم النتائج -->
        <div id="resultContainer" style="display: none;">
            <div class="result-section">
                <h3>النتائج</h3>
                <div id="resultContent"></div>
                <button id="downloadPdf" class="btn btn-primary mt-3">
                    <span class="material-icons-outlined">download</span> تحميل التقرير بصيغة PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        // إظهار/إخفاء الحقول بناءً على الخيارات
        const checkboxes = [
            { id: 'hasMap', fields: 'technicalDetails' },
            { id: 'customFacadeInfo', fields: 'customFacadeFields' },
            { id: 'waffleSlabInfo', fields: 'waffleSlabFields' },
            { id: 'apartmentsInfo', fields: 'apartmentsFields' },
            { id: 'basementInfo', fields: 'basementFields' },
            { id: 'stairsRailingInfo', fields: 'stairsRailingFields' },
            { id: 'internalWallsInfo', fields: 'internalWallsFields' },
            { id: 'concreteColumnsInfo', fields: 'concreteColumnsFields' }
        ];

        checkboxes.forEach(({ id, fields }) => {
            const checkbox = document.getElementById(id);
            const fieldContainer = document.getElementById(fields);
            if (checkbox && fieldContainer) {
                checkbox.addEventListener('change', () => {
                    fieldContainer.style.display = checkbox.checked ? 'block' : 'none';
                });
            }
        });

        // معالجة إرسال النموذج
        let lastResult = null; // لتخزين آخر استجابة لاستخدامها في PDF
        document.getElementById('buildingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<span class="material-icons-outlined">hourglass_top</span> جارٍ الحساب...';
            submitBtn.disabled = true;

            const getValue = (id, isFloat = false, isInt = false, isCheckbox = false) => {
                const element = document.getElementById(id);
                if (!element) return isCheckbox ? false : isInt ? 0 : isFloat ? 0 : '';
                if (isCheckbox) return element.checked;
                let value = element.value.replace(/,/g, '');
                return isFloat ? parseFloat(value) || 0 : isInt ? parseInt(value) || 0 : value;
            };

            try {
                const inputs = {
                    customer: {
                        name: getValue('customerName'),
                        phone: getValue('customerPhone')
                    },
                    location: {
                        governorate: getValue('governorate'),
                        area: getValue('area')
                    },
                    land: {
                        area: getValue('landArea', true),
                        facadeWidth: getValue('facadeWidth', true)
                    },
                    building: {
                        floors: getValue('floors', false, true),
                        rooms: getValue('rooms', false, true),
                        bathrooms: getValue('bathrooms', false, true),
                        groundFloorHeight: getValue('groundFloorHeight', true),
                        otherFloorsHeight: getValue('otherFloorsHeight', true),
                        ceilingThickness: getValue('ceilingThickness', true),
                        brickType: getValue('brickType'),
                        ceilingDetails: getValue('ceilingDetails'),
                        facadeType: getValue('facadeType'),
                        hasGarden: getValue('hasGarden', false, false, true),
                        hasPool: getValue('hasPool', false, false, true),
                        hasHVAC: getValue('hasHVAC', false, false, true),
                        hasElevator: getValue('hasElevator', false, false, true),
                        hasFence: getValue('hasFence', false, false, true),
                        voidSize: getValue('waffleSlabInfo', false, false, true) ? getValue('voidSize', true) : 0,
                        voidCount: getValue('waffleSlabInfo', false, false, true) ? getValue('voidCount', false, true) : 0,
                        facadeArea: getValue('customFacadeInfo terminate action', false, false, true) ? getValue('facadeArea', true) : 0,
                        apartmentsCount: getValue('apartmentsInfo', false, false, true) ? getValue('apartmentsCount', false, true) : 0,
                        basementFloors: getValue('basementInfo', false, false, true) ? getValue('basementFloors', false, true) : 0,
                        basementCeilingArea: getValue('basementInfo', false, false, true) ? getValue('basementCeilingArea', true) : 0,
                        basementPrice: getValue('basementInfo', false, false, true) ? getValue('basementPrice', true) : 0
                    },
                    prices: {
                        flooring: getValue('flooringPrice', true),
                        wallInstallation: getValue('wallInstallationPrice', true),
                        wallPainting: getValue('wallPaintingPrice', true),
                        windowsDoors: getValue('windowsDoorsPrice', true),
                        facadePrice: getValue('customFacadeInfo', false, false, true) ? getValue('facadePrice', true) : 0,
                        stairsRailing: getValue('stairsRailingInfo', false, false, true) ? getValue('stairsRailingPrice', true) : 0,
                        internalWalls: getValue('internalWallsInfo', false, false, true) ? getValue('internalWallsPrice', true) : 0
                    },
                    hasMap: getValue('hasMap', false, false, true),
                    technicalDetails: getValue('hasMap', false, false, true) ? {
                        totalRoofArea: getValue('totalRoofArea', true),
                        gardenArea: getValue('gardenArea', true),
                        garagePathArea: getValue('garagePathArea', true),
                        skylightsArea: getValue('skylightsArea', true),
                        tiesLength: getValue('tiesLength', true),
                        invertedBeams: getValue('invertedBeams', true),
                        externalWalls24cm: getValue('externalWalls24cm', true),
                        internalWalls24cm: getValue('internalWalls24cm', true),
                        roofFenceLength: getValue('roofFenceLength', true),
                        externalDoors: getValue('externalDoors', false, true),
                        internalDoors: getValue('internalDoors', false, true),
                        facadeWindowsDoorsArea: getValue('facadeWindowsDoorsArea', true),
                        skylightWindowsDoorsArea: getValue('skylightWindowsDoorsArea', true),
                        secondaryCeilingsArea: getValue('secondaryCeilingsArea', true),
                        decorativeWallsArea: getValue('decorativeWallsArea', true),
                        claddingWallsArea: getValue('claddingWallsArea', true),
                        plasterWallsArea: getValue('plasterWallsArea', true),
                        concreteVolume: getValue('concreteColumnsInfo', false, false, true) ? getValue('concreteVolume', true) : 0,
                        stairsRailingLength: getValue('stairsRailingInfo', false, false, true) ? getValue('stairsRailingLength', true) : 0,
                        internalWallsArea: getValue('internalWallsInfo', false, false, true) ? getValue('internalWallsArea', true) : 0
                    } : {},
                    customFacadeInfo: getValue('customFacadeInfo', false, false, true),
                    waffleSlabInfo: getValue('waffleSlabInfo', false, false, true),
                    apartmentsInfo: getValue('apartmentsInfo', false, false, true),
                    basementInfo: getValue('basementInfo', false, false, true),
                    stairsRailingInfo: getValue('stairsRailingInfo', false, false, true),
                    internalWallsInfo: getValue('internalWallsInfo', false, false, true),
                    concreteColumnsInfo: getValue('concreteColumnsInfo', false, false, true)
                };

                const response = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inputs)
                });

                console.log('Response Status:', response.status);
                if (!response.ok) {
                    throw new Error(`خطأ في الاتصال: ${response.status}`);
                }

                const result = await response.json();
                console.log('API Response:', result);
                lastResult = result; // تخزين الاستجابة لـ PDF

                const resultContainer = document.getElementById('resultContainer');
                const resultContent = document.getElementById('resultContent');

                if (result.success && result.result && result.result.pdfData) {
                    let tableRows = `
                        <tr><th>البيان</th><th>القيمة</th></tr>
                        <tr><td>الرسالة</td><td>${result.result.message}</td></tr>
                    `;

                    // بيانات العميل
                    tableRows += `<tr><td colspan="2"><strong>${result.result.pdfData.customer.title}</strong></td></tr>`;
                    result.result.pdfData.customer.fields.forEach(field => {
                        tableRows += `<tr><td>${field.label}</td><td>${field.value}</td></tr>`;
                    });

                    // معلومات الموقع
                    tableRows += `<tr><td colspan="2"><strong>${result.result.pdfData.location.title}</strong></td></tr>`;
                    result.result.pdfData.location.fields.forEach(field => {
                        tableRows += `<tr><td>${field.label}</td><td>${field.value}</td></tr>`;
                    });

                    // تفاصيل الكميات
                    tableRows += `<tr><td colspan="2"><strong>تفاصيل الكميات الهندسية</strong></td></tr>`;
                    result.result.pdfData.quantities.sections.forEach(section => {
                        tableRows += `<tr><td colspan="2">${section.subtitle}</td></tr>`;
                        section.items.forEach(item => {
                            tableRows += `<tr><td>${item.name}</td><td>${item.value.toLocaleString()} ${item.unit}</td></tr>`;
                        });
                    });

                    // تفاصيل التكاليف
                    tableRows += `<tr><td colspan="2"><strong>${result.result.pdfData.costs.title}</strong></td></tr>`;
                    result.result.pdfData.costs.items.forEach(item => {
                        tableRows += `<tr><td>${item.name}</td><td>${item.value.toLocaleString()} ${item.unit}</td></tr>`;
                    });

                    tableRows += `<tr><td><strong>الإجمالي</strong></td><td>${result.result.pdfData.costs.total.toLocaleString()} د.ع</td></tr>`;

                    resultContent.innerHTML = `
                        <div class="result-section" id="pdfContent">
                            <h3>النتائج</h3>
                            <table>${tableRows}</table>
                        </div>`;
                    resultContainer.style.display = 'block';
                } else {
                    throw new Error(result.result?.message || result.error || 'خطأ في معالجة البيانات');
                }

                // زر تحميل PDF
                document.getElementById('downloadPdf').onclick = () => {
                    if (!lastResult || !lastResult.result || !lastResult.result.pdfData) {
                        alert('لا توجد بيانات لتحميلها. الرجاء حساب التكلفة أولاً.');
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    doc.setFont('Arial', 'normal'); // Arial لدعم العربية بشكل افتراضي
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);

                    let y = 10;
                    // عنوان التقرير
                    doc.text('تقرير تكاليف البناء', 190, y, { align: 'right' });
                    y += 10;

                    // بيانات العميل
                    doc.text(lastResult.result.pdfData.customer.title, 190, y, { align: 'right' });
                    y += 5;
                    lastResult.result.pdfData.customer.fields.forEach(field => {
                        doc.text(`${field.label}: ${field.value}`, 190, y, { align: 'right' });
                        y += 5;
                    });

                    // معلومات الموقع
                    y += 5;
                    doc.text(lastResult.result.pdfData.location.title, 190, y, { align: 'right' });
                    y += 5;
                    lastResult.result.pdfData.location.fields.forEach(field => {
                        doc.text(`${field.label}: ${field.value}`, 190, y, { align: 'right' });
                        y += 5;
                    });

                    // تفاصيل الكميات
                    y += 10;
                    doc.text('تفاصيل الكميات الهندسية', 190, y, { align: 'right' });
                    y += 5;
                    lastResult.result.pdfData.quantities.sections.forEach(section => {
                        doc.text(section.subtitle, 190, y, { align: 'right' });
                        y += 5;
                        section.items.forEach(item => {
                            doc.text(`${item.name}: ${item.value.toLocaleString()} ${item.unit}`, 190, y, { align: 'right' });
                            y += 5;
                            if (y > 270) { // التحقق من نهاية الصفحة
                                doc.addPage();
                                y = 10;
                            }
                        });
                    });

                    // تفاصيل التكاليف
                    y += 10;
                    doc.text(lastResult.result.pdfData.costs.title, 190, y, { align: 'right' });
                    y += 5;
                    lastResult.result.pdfData.costs.items.forEach(item => {
                        doc.text(`${item.name}: ${item.value.toLocaleString()} ${item.unit}`, 190, y, { align: 'right' });
                        y += 5;
                        if (y > 270) {
                            doc.addPage();
                            y = 10;
                        }
                    });
                    doc.text(`الإجمالي: ${lastResult.result.pdfData.costs.total.toLocaleString()} د.ع`, 190, y, { align: 'right' });

                    doc.save('تقرير_تكاليف_البناء.pdf');
                };
            } catch (error) {
                console.error('Error:', error);
                resultContent.innerHTML = `<p class="error-message">خطأ: ${error.message}</p>`;
                resultContainer.style.display = 'block';
            } finally {
                submitBtn.innerHTML = '<span class="material-icons-outlined">calculate</span> حساب التكلفة';
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
